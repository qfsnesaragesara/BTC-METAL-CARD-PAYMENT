<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Member Portal â€” QFS</title>
<meta name="robots" content="noindex, nofollow">
<link rel="icon" type="image/png" href="https://github.com/qfsnesaragesara/BTC-METAL-CARD-PAYMENT/blob/main/photo%201.jpg?raw=true" />

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  :root{
    --bg:#020617;
    --text:#e5e7eb;
    --muted:#9ca3af;
    --accent:#38bdf8;
    --accent2:#a855f7;
    --glass:rgba(15,23,42,0.88);
    --border:rgba(148,163,184,0.45);
    --shadow:rgba(2,6,23,0.9);
    --radius:18px;
    --maxw:1100px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    min-height:100vh;
    padding:24px;
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    color:var(--text);
    background:
      radial-gradient(circle at top, rgba(56,189,248,0.30), transparent 55%),
      radial-gradient(circle at bottom, rgba(147,51,234,0.32), transparent 60%),
      var(--bg);
  }

  /* âœ… Force header above everything + clickable */
  .wrap{ max-width:var(--maxw); margin:0 auto; position:relative; z-index:1; }
  .header,
  .header-actions,
  .pill,
  .badge,
  #logoutBtn{
    position:relative;
    z-index:999999;
    pointer-events:auto !important;
  }

  .header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:14px;
    margin-bottom:18px;
  }
  .brand{ display:flex; align-items:center; gap:12px; }
  .logo{
    width:54px; height:54px;
    border-radius:14px;
    object-fit:cover;
    box-shadow:
      0 14px 44px rgba(2,6,23,0.95),
      0 0 0 1px rgba(148,163,184,0.35);
  }
  .brand h1{
    margin:0;
    font-size:18px;
    font-weight:900;
    letter-spacing:-0.02em;
  }
  .brand .subline{
    font-size:12px;
    color:var(--muted);
    display:flex;
    gap:8px;
    align-items:center;
    flex-wrap:wrap;
    margin-top:2px;
  }
  .hello{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:4px 10px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,0.25);
    background:rgba(255,255,255,0.05);
    color:#dbeafe;
    font-weight:850;
    font-size:12px;
  }

  .header-actions{
    display:flex;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
    justify-content:flex-end;
  }

  #logoutBtn{
    padding:8px 12px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,0.35);
    background:rgba(255,255,255,0.06);
    color:var(--text);
    font-weight:900;
    font-size:12px;
    cursor:pointer;
  }

  .badge{
    padding:6px 10px;
    border-radius:999px;
    font-size:11px;
    font-weight:900;
    letter-spacing:0.06em;
    text-transform:uppercase;
    border:1px solid rgba(148,163,184,0.30);
    background:rgba(2,6,23,0.40);
    color:#e5e7eb;
  }
  .badge.pending{ border-color: rgba(251,191,36,0.35); color:#fde68a; }
  .badge.active{ border-color: rgba(34,197,94,0.35); color:#bbf7d0; }
  .badge.rejected{ border-color: rgba(244,63,94,0.35); color:#fecdd3; }

  .grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:18px;
  }
  @media (max-width:860px){ .grid{ grid-template-columns:1fr; } }

  .card{
    background:linear-gradient(145deg, rgba(15,23,42,0.96), rgba(15,23,42,0.84));
    border:1px solid var(--border);
    border-radius:28px;
    padding:20px;
    box-shadow: 0 28px 110px var(--shadow);
    backdrop-filter: blur(26px);
    position:relative;
    overflow:hidden;
    z-index:1;
  }
  .card:before{
    content:"";
    position:absolute;
    inset:-120px -120px auto auto;
    width:320px;
    height:320px;
    background: radial-gradient(circle at center, rgba(56,189,248,0.18), transparent 60%);
    pointer-events:none;
  }

  .card h2{ margin:0 0 6px; font-size:16px; font-weight:900; }
  .sub{ font-size:12px; color:var(--muted); }

  .balance{
    font-size:34px;
    font-weight:900;
    margin:12px 0 4px;
    background:linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
  }
  .btc{
    font-size:13px;
    color:#cbd5f5;
    line-height:1.55;
  }

  .actions{ display:flex; gap:12px; margin-top:14px; flex-wrap:wrap; }
  .btn{
    flex:1;
    padding:12px 14px;
    border-radius:999px;
    border:none;
    cursor:pointer;
    font-weight:900;
    font-size:13px;
    letter-spacing:0.04em;
    position:relative;
    z-index:2;
  }
  .btn-primary{
    background:linear-gradient(135deg, var(--accent), var(--accent2));
    color:#fff;
  }
  .btn-disabled{
    background:rgba(255,255,255,0.06);
    border:1px dashed rgba(148,163,184,0.45);
    color:var(--muted);
    cursor:not-allowed;
  }

  .status{
    margin-top:10px;
    padding:10px 12px;
    border-radius:14px;
    background:rgba(2,6,23,0.45);
    border:1px solid rgba(148,163,184,0.35);
    font-size:12px;
  }

  /* âœ… Smart CTA button (hidden unless needed) */
  .ctaRow{
    margin-top:10px;
    display:none;
    gap:10px;
    align-items:center;
    flex-wrap:wrap;
  }
  .ctaRow a{
    text-decoration:none;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    padding:10px 14px;
    border-radius:999px;
    font-weight:900;
    font-size:12px;
    letter-spacing:0.06em;
    text-transform:uppercase;
    background:linear-gradient(135deg, var(--accent), var(--accent2));
    color:#fff;
    border:none;
    cursor:pointer;
  }
  .ctaRow .hint{
    font-size:12px;
    color:rgba(148,163,184,0.95);
  }

  table{
    width:100%;
    border-collapse:collapse;
    margin-top:10px;
    font-size:12px;
  }
  th, td{
    padding:10px 8px;
    border-bottom:1px solid rgba(148,163,184,0.2);
    text-align:left;
  }
  th{
    color:var(--muted);
    font-weight:700;
    text-transform:uppercase;
    font-size:11px;
  }

  .mutedline{ color:var(--muted); font-size:12px; margin-top:8px; }

  #toast{
    position:fixed;
    left:12px;
    bottom:12px;
    z-index:9999999;
    background:rgba(2,6,23,0.75);
    border:1px solid rgba(148,163,184,0.35);
    color:#cbd5e1;
    padding:8px 10px;
    border-radius:12px;
    font-size:12px;
    user-select:none;
    max-width:min(520px, 92vw);
    white-space:pre-wrap;
  }
</style>
</head>

<body>
<div class="wrap">

  <header class="header">
    <div class="brand">
      <img class="logo"
        src="https://github.com/qfsnesaragesara/BTC-METAL-CARD-PAYMENT/blob/main/photo%201.jpg?raw=true"
        alt="QFS NESARA GESARA" />
      <div>
        <h1>Member Portal</h1>
        <div class="subline">
          <span>QFS NESARA GESARA</span>
          <span class="hello" id="helloName" style="display:none;">Hi, â€”</span>
        </div>
      </div>
    </div>

    <div class="header-actions">
      <span id="statusBadge" class="badge pending">Pending</span>
      <button id="logoutBtn" type="button">Logout</button>
    </div>
  </header>

  <section class="grid">

    <div class="card">
      <h2>Available Balance</h2>
      <div class="sub" id="balanceHelp">Balance becomes active after you order your access card</div>

      <div class="balance" id="balance">$0.00</div>
      <div class="btc" id="btcBalance">â€”</div>

      <div class="actions">
        <button id="sendBtn" class="btn btn-disabled" disabled>Send</button>
        <button id="receiveBtn" class="btn btn-disabled" disabled>Receive</button>
      </div>

      <div class="status" id="lockNote">
        ðŸ”’ Send & Receive are locked until you activate your access card.
      </div>

      <!-- âœ… Smart CTA -->
      <div class="ctaRow" id="ctaRow">
        <a id="ctaBtn" href="confirmation-page.html">Submit Confirmation</a>
        <span class="hint" id="ctaHint">Use the same email you registered with.</span>
      </div>

      <div class="mutedline" id="lastChecked">Checking confirmationâ€¦</div>
    </div>

    <div class="card">
      <h2>Account Details</h2>
      <div class="sub">Your Membership Balance</div>

      <table>
        <tr>
          <th>Name</th>
          <td id="nameCell">â€”</td>
        </tr>
        <tr>
          <th>Email</th>
          <td id="emailCell">â€”</td>
        </tr>
        <tr>
          <th>Tier</th>
          <td id="tierCell">â€”</td>
        </tr>
        <tr>
          <th>Quantity</th>
          <td id="qtyCell">â€”</td>
        </tr>
        <tr>
          <th>Status</th>
          <td id="statusCell">Pending</td>
        </tr>
      </table>

    </div>

    <div class="card" style="grid-column:1 / -1;">
      <h2>Recent Activity</h2>
      <div class="sub" id="activityHelp">Transactions will appear after activation</div>

      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Type</th>
            <th>Amount</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td colspan="4" style="color:var(--muted);">No activity yet</td>
          </tr>
        </tbody>
      </table>
    </div>

  </section>
</div>

<div id="toast">bootâ€¦</div>

<script>
  const SUPABASE_URL = "https://qagktukzxtwbjrdgiben.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFhZ2t0dWt6eHR3YmpyZGdpYmVuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4NDA0NTQsImV4cCI6MjA4MzQxNjQ1NH0.cbhSWHGlmhmIt-NmUVBUtAhPpNPDKk4Bz-Gy1TbPzHk";

  const $ = (id) => document.getElementById(id);
  const toast = $("toast");
  const say = (t) => { if(toast) toast.textContent = String(t || ""); };

  // âœ… ONE shared client (prevents "supabase already declared" issues)
  const sb = (window.__qfsSupabase ||= window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY));

  // Keep current tier/qty so smart messaging can use it
  let CURRENT_TIER = "";
  let CURRENT_QTY = 0;

  function normTier(v){
    const s = String(v || "").trim().toLowerCase();
    return (s === "gold" || s === "silver" || s === "black") ? s : "";
  }

  function pickNameFromUser(user){
    const md = user?.user_metadata || {};
    const first = String(md.first_name || "").trim();
    const middle = String(md.middle_name || "").trim();
    const last = String(md.last_name || "").trim();
    const fullFromParts = [first, middle, last].filter(Boolean).join(" ").trim();

    const raw =
      md.full_name ||
      md.name ||
      fullFromParts ||
      md.username ||
      md.display_name ||
      "";

    const cleaned = String(raw || "").trim();
    if(cleaned) return cleaned;

    const email = String(user?.email || "").trim();
    if(email && email.includes("@")){
      const left = email.split("@")[0] || "";
      const pretty = left
        .replace(/[._-]+/g, " ")
        .replace(/\s+/g, " ")
        .trim();
      if(pretty) return pretty.charAt(0).toUpperCase() + pretty.slice(1);
    }
    return "Member";
  }

  function setBadge(status){
    const b = $("statusBadge");
    b.classList.remove("pending","active","rejected");
    if(status === "confirmed"){
      b.textContent = "Active";
      b.classList.add("active");
    } else if(status === "rejected"){
      b.textContent = "Rejected";
      b.classList.add("rejected");
    } else {
      b.textContent = "Pending";
      b.classList.add("pending");
    }
  }

  function showCTA(show, variant){
    const row = $("ctaRow");
    const btn = $("ctaBtn");
    const hint = $("ctaHint");
    if(!row || !btn || !hint) return;

    if(!show){
      row.style.display = "none";
      return;
    }

    row.style.display = "flex";

    if(variant === "rejected"){
      btn.textContent = "Resubmit Confirmation";
      hint.textContent = "Your last submission was rejected â€” submit again with the same email.";
    } else {
      btn.textContent = "Submit Confirmation";
      hint.textContent = "If you already paid, submit your confirmation to activate your account.";
    }
  }

  function lockActions(reason){
    $("sendBtn").disabled = true;
    $("receiveBtn").disabled = true;

    $("sendBtn").classList.add("btn-disabled");
    $("receiveBtn").classList.add("btn-disabled");

    $("sendBtn").classList.remove("btn-primary");
    $("receiveBtn").classList.remove("btn-primary");

    $("lockNote").style.display = "block";

    const tier = String(CURRENT_TIER || "").toUpperCase();
    const qty = Number(CURRENT_QTY || 0) || 0;

    if(reason === "rejected"){
      $("lockNote").textContent = "âŒ Payment rejected â€” please resubmit your payment confirmation.";
      $("balanceHelp").style.display = "block";
      $("balanceHelp").textContent = "Your allocation is on hold until a successful confirmation is approved.";
      $("activityHelp").style.display = "block";
      $("activityHelp").textContent = "No transactions will show while your account is not active.";
      showCTA(true, "rejected");
      return;
    }

    // pending
    if(tier === "SILVER" || tier === "BLACK"){
      $("balanceHelp").style.display = "block";
      $("balanceHelp").textContent = "Allocation reserved â€” becomes active after confirmation.";
    } else {
      $("balanceHelp").style.display = "block";
      $("balanceHelp").textContent = "Balance becomes active after you order your access card";
    }

    $("lockNote").textContent = "ðŸ”’ Send & Receive are locked until your account becomes active.";
    $("activityHelp").style.display = "block";
    $("activityHelp").textContent = "Transactions will appear after activation";

    showCTA(true, "pending");
  }

  function unlockActions(){
    $("sendBtn").disabled = false;
    $("receiveBtn").disabled = false;

    $("sendBtn").classList.remove("btn-disabled");
    $("receiveBtn").classList.remove("btn-disabled");

    $("sendBtn").classList.add("btn-primary");
    $("receiveBtn").classList.add("btn-primary");

    // âœ… Smart UI: remove help when active
    $("balanceHelp").style.display = "none";
    $("activityHelp").style.display = "none";

    $("lockNote").style.display = "block";
    $("lockNote").textContent = "âœ… Account Active â€” Send & Receive are unlocked.";

    showCTA(false);
  }

  function fmtUSD(n){
    return "$" + Number(n).toLocaleString(undefined, { maximumFractionDigits: 2 });
  }

  async function fetchBtcUsd(){
    try{
      const r = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd");
      const j = await r.json();
      return Number(j?.bitcoin?.usd || 0);
    } catch {
      return 0;
    }
  }

  function setAllocationUI(tierUpper, qty){
    const tier = (tierUpper || "").toUpperCase();
    $("tierCell").textContent = tier || "â€”";
    $("qtyCell").textContent = qty ? String(qty) : "â€”";

    $("balance").textContent = "$0.00";
    $("btcBalance").textContent = "â€”";

    if(tier === "SILVER"){
      const usdBalance = 25000 * qty;
      $("balance").textContent = fmtUSD(usdBalance);
      $("btcBalance").textContent = "â‰ˆ $25,000 per card allocation";
    }

    if(tier === "BLACK"){
      $("balance").textContent = "25,000 BTC";
      $("btcBalance").textContent = "USD equivalent loadingâ€¦";
    }
  }

  function setBlackUsdEquivalent(btcUsd){
    if(!btcUsd) {
      $("btcBalance").textContent = "USD equivalent unavailable";
      return;
    }
    const usdEq = 25000 * btcUsd;
    $("btcBalance").textContent = "â‰ˆ " + fmtUSD(usdEq) + " (live BTC price)";
  }

  function hardToLogin(){
    try{
      localStorage.removeItem("qfsEmail");
      localStorage.removeItem("memberEmail");
      localStorage.removeItem("qfs_registering_for");
    } catch {}
    window.location.replace("login.html");
  }

  async function getSessionOrKick(){
    const { data, error } = await sb.auth.getSession();
    if(error || !data?.session) return null;
    return data.session;
  }

  async function getDbProfileByEmail(email){
    return await sb
      .from("portal_users")
      .select("email, tier, selected_tier, qty, is_active")
      .eq("email", email)
      .maybeSingle();
  }

  async function getLatestSubmissionStatus(email){
    try{
      const { data, error } = await sb
        .from("payment_submissions")
        .select("status, card_type, qty, created_at")
        .ilike("email", email)
        .order("created_at", { ascending:false })
        .limit(1);

      if(error || !data || !data[0]) return null;
      const s = String(data[0].status || "").toLowerCase();
      if(s === "confirmed" || s === "rejected" || s === "pending") return s;
      return "pending";
    } catch {
      return null;
    }
  }

  function sanitizeQty(tierUpper, qtyRaw){
    const tier = (tierUpper || "").toUpperCase();
    let qty = Number(qtyRaw || 0) || 0;

    if (tier === "BLACK") qty = 1;
    if (tier === "SILVER" && qty > 50) qty = 50;
    if (!Number.isFinite(qty) || qty < 1) qty = 1;

    return qty;
  }

  async function applyStatusUI(profile){
    const now = new Date();
    $("lastChecked").textContent = "Last checked: " + now.toLocaleString();

    const tierUpper = (profile?.tier || profile?.selected_tier || "").toUpperCase();
    const qty = sanitizeQty(tierUpper, profile?.qty);

    // cache for smart messaging
    CURRENT_TIER = tierUpper;
    CURRENT_QTY = qty;

    // Always show allocation based on tier/qty
    setAllocationUI(tierUpper, qty);

    // Decide final status once (prevents flip-flop)
    const email = String(profile?.email || "").trim().toLowerCase();
    let finalStatus = "pending";

    if (profile?.is_active === true) {
      finalStatus = "confirmed";
    } else if (email) {
      const s = await getLatestSubmissionStatus(email);
      if (s === "confirmed" || s === "rejected" || s === "pending") finalStatus = s;
    }

    $("statusCell").textContent =
      finalStatus === "confirmed" ? "Active" :
      finalStatus === "rejected" ? "Rejected" : "Pending";

    setBadge(finalStatus);

    if (finalStatus === "confirmed") unlockActions();
    else lockActions(finalStatus === "rejected" ? "rejected" : "pending");

    // BTC equivalent
    const tierShown = ($("tierCell").textContent || "").toUpperCase();
    if (tierShown === "BLACK"){
      const btcUsd = await fetchBtcUsd();
      setBlackUsdEquivalent(btcUsd);
    } else if (tierShown === "SILVER"){
      const btcUsd = await fetchBtcUsd();
      if (btcUsd){
        const qtyShown = Number($("qtyCell").textContent || 1);
        const usdBal = 25000 * (Number.isFinite(qtyShown) ? qtyShown : 1);
        const btcEq = usdBal / btcUsd;
        $("btcBalance").textContent = `â‰ˆ ${btcEq.toFixed(8)} BTC (live BTC price)`;
      }
    }
  }

  $("sendBtn").addEventListener("click", () => {
    alert("Send is enabled for Active accounts. (Next step: build real Send flow.)");
  });
  $("receiveBtn").addEventListener("click", () => {
    alert("Receive is enabled for Active accounts. (Next step: build real Receive flow.)");
  });

  $("logoutBtn").addEventListener("click", async () => {
    say("Signing outâ€¦");
    try{ await sb.auth.signOut(); } catch {}
    hardToLogin();
  });

  (async () => {
    try{
      say("Checking sessionâ€¦");
      const session = await getSessionOrKick();
      if(!session) return hardToLogin();

      const user = session.user || {};
      const email = (user.email || "").trim().toLowerCase();
      if(!email) return hardToLogin();

      const name = pickNameFromUser(user);
      $("nameCell").textContent = name;

      const hello = $("helloName");
      if(hello){
        hello.style.display = "inline-flex";
        hello.textContent = "Hi, " + name;
      }

      $("emailCell").textContent = email;
      try{
        localStorage.setItem("qfsEmail", email);
        localStorage.setItem("memberEmail", email);
      } catch {}

      say("Fetching profile by emailâ€¦");
      const { data: profile, error } = await getDbProfileByEmail(email);

      if(error){
        say("Profile SELECT blocked (RLS). portal_users read policy must allow this email.");
        lockActions("pending");
        return;
      }

      if(!profile){
        say("No profile row â†’ registration");
        return window.location.replace("registration.html");
      }

      const effectiveTier = normTier(profile.tier) || normTier(profile.selected_tier);
      if(effectiveTier === "gold"){
        say("Gold detected â†’ redirect portal-gold.html");
        return window.location.replace("portal-gold.html");
      }

      say("Loaded âœ…");
      await applyStatusUI(profile);

      setInterval(async () => {
        const { data: p2 } = await getDbProfileByEmail(email);
        if(p2){
          const t2 = normTier(p2.tier) || normTier(p2.selected_tier);
          if(t2 === "gold") return window.location.replace("portal-gold.html");
          await applyStatusUI(p2);
        }
      }, 20000);

    } catch(e){
      say("Boot error: " + (e?.message || e));
    }
  })();
</script>

</body>
</html>

