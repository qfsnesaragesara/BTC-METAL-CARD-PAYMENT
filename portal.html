<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Member Portal â€” QFS</title>
<meta name="robots" content="noindex, nofollow">
<link rel="icon" type="image/png" href="https://github.com/qfsnesaragesara/BTC-METAL-CARD-PAYMENT/blob/main/photo%201.jpg?raw=true" />

<script src="./config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  :root{
    --bg:#020617;
    --text:#e5e7eb;
    --muted:#9ca3af;
    --accent:#38bdf8;
    --accent2:#a855f7;
    --glass:rgba(15,23,42,0.88);
    --border:rgba(148,163,184,0.45);
    --shadow:rgba(2,6,23,0.9);
    --radius:18px;
    --maxw:1100px;

    /* tx colors */
    --tx-green:#22c55e;
    --tx-red:#ef4444;
  }

  *{box-sizing:border-box}
  body{
    margin:0;
    min-height:100vh;
    padding:24px;
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    color:var(--text);
    background:
      radial-gradient(circle at top, rgba(56,189,248,0.30), transparent 55%),
      radial-gradient(circle at bottom, rgba(147,51,234,0.32), transparent 60%),
      var(--bg);
  }

  .wrap{ max-width:var(--maxw); margin:0 auto; position:relative; z-index:1; }

  .header,.header-actions,.pill,.badge,#logoutBtn,#refreshBtn{
    position:relative; z-index:999999; pointer-events:auto !important;
  }
  .header{
    display:flex; justify-content:space-between; align-items:center;
    gap:14px; margin-bottom:18px;
  }
  .brand{ display:flex; align-items:center; gap:12px; }
  .logo{
    width:54px; height:54px; border-radius:14px; object-fit:cover;
    box-shadow: 0 14px 44px rgba(2,6,23,0.95), 0 0 0 1px rgba(148,163,184,0.35);
    background: rgba(255,255,255,0.06);
  }
  .brand h1{ margin:0; font-size:18px; font-weight:900; letter-spacing:-0.02em; }
  .brand .subline{
    font-size:12px; color:var(--muted); display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:2px;
  }
  .hello{
    display:inline-flex; align-items:center; gap:6px;
    padding:4px 10px; border-radius:999px;
    border:1px solid rgba(148,163,184,0.25);
    background:rgba(255,255,255,0.05);
    color:#dbeafe; font-weight:850; font-size:12px;
  }
  .header-actions{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end; }

  .actionBtn{
    padding:8px 12px; border-radius:999px;
    border:1px solid rgba(148,163,184,0.35);
    background:rgba(255,255,255,0.06);
    color:var(--text); font-weight:900; font-size:12px; cursor:pointer;
  }
  #logoutBtn{ background: rgba(255,255,255,0.06); }
  #refreshBtn{ background: rgba(255,255,255,0.06); }

  .badge{
    padding:6px 10px; border-radius:999px;
    font-size:11px; font-weight:900; letter-spacing:0.06em; text-transform:uppercase;
    border:1px solid rgba(148,163,184,0.30);
    background:rgba(2,6,23,0.40);
    color:#e5e7eb;
  }
  .badge.pending{ border-color: rgba(251,191,36,0.35); color:#fde68a; }
  .badge.active{ border-color: rgba(34,197,94,0.35); color:#bbf7d0; }
  .badge.rejected{ border-color: rgba(244,63,94,0.35); color:#fecdd3; }

  .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:18px; }
  @media (max-width:860px){ .grid{ grid-template-columns:1fr; } }

  .card{
    background:linear-gradient(145deg, rgba(15,23,42,0.96), rgba(15,23,42,0.84));
    border:1px solid var(--border);
    border-radius:28px;
    padding:20px;
    box-shadow: 0 28px 110px var(--shadow);
    backdrop-filter: blur(26px);
    position:relative; overflow:hidden; z-index:1;
  }
  .card:before{
    content:""; position:absolute; inset:-120px -120px auto auto;
    width:320px; height:320px;
    background: radial-gradient(circle at center, rgba(56,189,248,0.18), transparent 60%);
    pointer-events:none;
  }
  .card h2{ margin:0 0 6px; font-size:16px; font-weight:900; }
  .sub{ font-size:12px; color:var(--muted); }

  .balance{
    font-size:34px; font-weight:900; margin:12px 0 4px;
    background:linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
  }
  .btc{ font-size:13px; color:#cbd5f5; line-height:1.55; }

  .actions{ display:flex; gap:12px; margin-top:14px; flex-wrap:wrap; }
  .btn{
    flex:1; padding:12px 14px; border-radius:999px; border:none;
    cursor:pointer; font-weight:900; font-size:13px; letter-spacing:0.04em; position:relative; z-index:2;
  }
  .btn-primary{ background:linear-gradient(135deg, var(--accent), var(--accent2)); color:#fff; }
  .btn-disabled{
    background:rgba(255,255,255,0.06);
    border:1px dashed rgba(148,163,184,0.45);
    color:var(--muted);
    cursor:not-allowed;
  }

  .status{
    margin-top:10px; padding:10px 12px; border-radius:14px;
    background:rgba(2,6,23,0.45);
    border:1px solid rgba(148,163,184,0.35);
    font-size:12px;
  }

  table{ width:100%; border-collapse:collapse; margin-top:10px; font-size:12px; }
  th, td{ padding:10px 8px; border-bottom:1px solid rgba(148,163,184,0.2); text-align:left; vertical-align:top; }
  th{ color:var(--muted); font-weight:700; text-transform:uppercase; font-size:11px; }

  .mutedline{ color:var(--muted); font-size:12px; margin-top:8px; }

  /* tx styling */
  .tx-amt{ font-weight:900; }
  .tx-credit{ color: var(--tx-green); }
  .tx-debit{ color: var(--tx-red); }
  .tx-pill{
    display:inline-flex; align-items:center; justify-content:center;
    padding:3px 8px; border-radius:999px;
    border:1px solid rgba(148,163,184,0.28);
    background: rgba(255,255,255,0.04);
    font-weight:900; font-size:11px; letter-spacing:0.06em; text-transform:uppercase;
  }
  .tx-pill.credit{ border-color: rgba(34,197,94,0.35); color:#bbf7d0; }
  .tx-pill.debit{ border-color: rgba(239,68,68,0.35); color:#fecaca; }

  /* better mobile */
  @media (max-width:520px){
    body{ padding:14px; }
    .header{ flex-direction:column; align-items:flex-start; }
    .header-actions{ width:100%; justify-content:space-between; }
    .logo{ width:46px; height:46px; border-radius:12px; }
    .balance{ font-size:30px; }
    .card{ padding:16px; border-radius:24px; }
    th, td{ padding:9px 6px; }
  }

  #toast{
    position:fixed; left:12px; bottom:12px; z-index:9999999;
    background:rgba(2,6,23,0.75);
    border:1px solid rgba(148,163,184,0.35);
    color:#cbd5e1;
    padding:8px 10px; border-radius:12px; font-size:12px;
    user-select:none; max-width:min(520px, 92vw); white-space:pre-wrap;
  }
  .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
</style>
</head>

<body>
<div class="wrap">

  <header class="header">
    <div class="brand">
      <img class="logo"
        src="https://github.com/qfsnesaragesara/BTC-METAL-CARD-PAYMENT/blob/main/photo%201.jpg?raw=true"
        alt="QFS NESARA GESARA"
        onerror="this.onerror=null; this.src='https://via.placeholder.com/54x54.png?text=QFS';" />
      <div>
        <h1>Member Portal</h1>
        <div class="subline">
          <span>QFS NESARA GESARA</span>
          <span class="hello" id="helloName" style="display:none;">Hi, â€”</span>
        </div>
      </div>
    </div>

    <div class="header-actions">
      <span id="statusBadge" class="badge pending">Pending</span>
      <button id="refreshBtn" class="actionBtn" type="button">Refresh</button>
      <button id="logoutBtn" class="actionBtn" type="button">Logout</button>
    </div>
  </header>

  <section class="grid">

    <div class="card">
      <h2>Available Balance</h2>
      <div class="sub" id="balanceHelp">Balance becomes active after your card payment is confirmed</div>

      <div class="balance" id="balance">$0.00</div>
      <div class="btc" id="btcBalance">â€”</div>

      <div class="actions">
        <button id="sendBtn" class="btn btn-disabled" disabled>Send</button>
        <button id="receiveBtn" class="btn btn-disabled" disabled>Receive</button>
      </div>

      <div class="status" id="lockNote">
        ðŸ”’ Send & Receive are locked until your account is activated with the QR code at the back of your Card.
      </div>

      <div class="mutedline" id="lastChecked">Checking statusâ€¦</div>
    </div>

    <div class="card">
      <h2>Account Details</h2>
      <div class="sub">Your Membership</div>

      <table>
        <tr><th>Name</th><td id="nameCell">â€”</td></tr>
        <tr><th>Email</th><td id="emailCell">â€”</td></tr>
        <tr><th>Tier</th><td id="tierCell">â€”</td></tr>
        <tr><th>Quantity</th><td id="qtyCell">â€”</td></tr>
        <tr><th>Status</th><td id="statusCell">Pending</td></tr>
      </table>
    </div>

    <div class="card" style="grid-column:1 / -1;">
      <h2>Recent Transactions</h2>
      <div class="sub">Credits show <span style="color:var(--tx-green);font-weight:900;">green</span>, debits show <span style="color:var(--tx-red);font-weight:900;">red</span></div>

      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Description</th>
            <th>Type</th>
            <th>Currency</th>
            <th class="mono">Amount</th>
          </tr>
        </thead>
        <tbody id="ordersBody">
          <tr><td colspan="5" style="color:var(--muted);">Loadingâ€¦</td></tr>
        </tbody>
      </table>
    </div>

  </section>
</div>

<div id="toast">bootâ€¦</div>

<script>
  const CFG = window.__QFS_CONFIG || {};
  const SUPABASE_URL = CFG.SUPABASE_URL || "https://qagktukzxtwbjrdgiben.supabase.co";
  const SUPABASE_ANON_KEY = CFG.SUPABASE_ANON_KEY || "PASTE_ANON_KEY_HERE_IF_NO_CONFIG_JS";

  const $ = (id) => document.getElementById(id);
  const toast = $("toast");
  const say = (t) => { if(toast) toast.textContent = String(t || ""); };

  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  function normTier(v){
    const s = String(v || "").trim().toLowerCase();
    return (s === "gold" || s === "silver" || s === "black") ? s : "";
  }

  function pickNameFromUser(user){
    const md = user?.user_metadata || {};
    const raw = md.full_name || md.name || md.first_name || md.username || md.display_name || "";
    const cleaned = String(raw || "").trim();
    if(cleaned) return cleaned;

    const email = String(user?.email || "").trim();
    if(email && email.includes("@")){
      const left = email.split("@")[0] || "";
      const pretty = left.replace(/[._-]+/g, " ").replace(/\s+/g, " ").trim();
      if(pretty) return pretty.charAt(0).toUpperCase() + pretty.slice(1);
    }
    return "Member";
  }

  function setBadge(active){
    const b = $("statusBadge");
    b.classList.remove("pending","active","rejected");
    if(active){
      b.textContent = "Active";
      b.classList.add("active");
    } else {
      b.textContent = "Pending";
      b.classList.add("pending");
    }
  }

  function lockActions(){
    $("sendBtn").disabled = true;
    $("receiveBtn").disabled = true;
    $("sendBtn").classList.add("btn-disabled");
    $("receiveBtn").classList.add("btn-disabled");
    $("sendBtn").classList.remove("btn-primary");
    $("receiveBtn").classList.remove("btn-primary");
    $("lockNote").style.display = "block";
    $("lockNote").textContent = "ðŸ”’ Send & Receive are locked until your account is activated with the QR code at the back of your Card.";
    $("balanceHelp").style.display = "block";
  }

  function unlockActions(){
    $("sendBtn").disabled = false;
    $("receiveBtn").disabled = false;
    $("sendBtn").classList.remove("btn-disabled");
    $("receiveBtn").classList.remove("btn-disabled");
    $("sendBtn").classList.add("btn-primary");
    $("receiveBtn").classList.add("btn-primary");
    $("balanceHelp").style.display = "none";
    $("lockNote").style.display = "block";
    $("lockNote").textContent = "âœ… Account Active â€” Send & Receive are unlocked.";
  }

  function fmtUSD(n){
    return "$" + Number(n).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }

  function fmtAmount(currency, amountCents, amountSats){
    const cur = String(currency || "").toUpperCase();
    if(cur === "USD"){
      const cents = Number(amountCents || 0);
      const usd = cents / 100;
      return fmtUSD(usd);
    }
    if(cur === "BTC"){
      const sats = Number(amountSats || 0);
      return `${sats.toLocaleString()} sats`;
    }
    return "â€”";
  }

  async function fetchBtcUsd(){
    try{
      const r = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd");
      const j = await r.json();
      return Number(j?.bitcoin?.usd || 0);
    } catch {
      return 0;
    }
  }

  function hardToLogin(){
    try{
      localStorage.removeItem("qfsEmail");
      localStorage.removeItem("memberEmail");
      localStorage.removeItem("qfs_registering_for");
      localStorage.removeItem("qfs_selected_tier");
    } catch {}
    window.location.replace("login.html");
  }

  function esc(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  async function getSessionOrKick(){
    const { data, error } = await sb.auth.getSession();
    if(error || !data?.session) return null;
    return data.session;
  }

  async function getDbProfileByEmail(email){
    return await sb
      .from("portal_users")
      .select("id, email, tier, selected_tier, qty, is_active")
      .eq("email", email)
      .maybeSingle();
  }

  async function getAccountsByUserId(userId){
    return await sb
      .from("portal_accounts")
      .select("id, currency, balance_cents, balance_sats")
      .eq("user_id", userId);
  }

  function getAccount(accounts, currency){
    const cur = String(currency || "").toUpperCase();
    return (accounts || []).find(a => String(a.currency || "").toUpperCase() === cur) || null;
  }

  async function renderBalanceFromDb(tierUpper, accounts){
    const tier = (tierUpper || "").toUpperCase();

    $("balance").textContent = "$0.00";
    $("btcBalance").textContent = "â€”";

    const usdAcc = getAccount(accounts, "USD");
    const btcAcc = getAccount(accounts, "BTC");

    const btcUsd = await fetchBtcUsd();

    if (tier === "SILVER") {
      const cents = Number(usdAcc?.balance_cents || 0);
      const usd = cents / 100;
      $("balance").textContent = fmtUSD(usd);

      if (btcUsd && usd > 0) {
        const btcEq = usd / btcUsd;
        $("btcBalance").textContent = `â‰ˆ ${btcEq.toFixed(8)} BTC (live BTC price)`;
      } else {
        $("btcBalance").textContent = "â€”";
      }
      return;
    }

    if (tier === "BLACK") {
      const sats = Number(btcAcc?.balance_sats || 0);
      const btc = sats / 1e8;

      $("balance").textContent = (btc === 0 ? "0 BTC" : `${btc.toLocaleString(undefined, { maximumFractionDigits: 8 })} BTC`);

      if (btcUsd && btc > 0) {
        const usdEq = btc * btcUsd;
        $("btcBalance").textContent = `â‰ˆ ${fmtUSD(usdEq)} (live BTC price)`;
      } else {
        $("btcBalance").textContent = "USD equivalent unavailable";
      }
      return;
    }

    $("btcBalance").textContent = "â€”";
  }

  function isCreditLike(entryType){
    const t = String(entryType || "").toLowerCase();
    if(t.includes("credit")) return true;
    if(t.includes("debit")) return false;
    if(t.includes("add")) return true;
    if(t.includes("sub")) return false;
    if(t.includes("deposit")) return true;
    if(t.includes("withdraw")) return false;
    return null; // unknown
  }

  function amountWithSign(cur, cents, sats, credit){
    const base = fmtAmount(cur, cents, sats);
    if(base === "â€”") return base;
    if(credit === true) return "+ " + base;
    if(credit === false) return "âˆ’ " + base;
    return base;
  }

  async function loadRecentTransactionsByUserId(userId){
    const body = $("ordersBody");
    if(!body) return;

    body.innerHTML = `<tr><td colspan="5" style="color:var(--muted);">Loadingâ€¦</td></tr>`;

    // 1) Get this user's account IDs (USD/BTC accounts)
    const { data: accRows, error: accErr } = await sb
      .from("portal_accounts")
      .select("id")
      .eq("user_id", userId);

    if(accErr){
      body.innerHTML = `<tr><td colspan="5" style="color:var(--muted);">Transactions blocked (RLS): ${esc(accErr.message)}</td></tr>`;
      return;
    }

    const accountIds = (accRows || []).map(r => r.id).filter(Boolean);

    if(accountIds.length === 0){
      body.innerHTML = `<tr><td colspan="5" style="color:var(--muted);">No transactions yet.</td></tr>`;
      return;
    }

    // 2) Pull ledger entries for those accounts
    // IMPORTANT: We query by account_id (NOT portal_ledger.user_id).
    // We also try a fallback select if your column names differ.
    let rows = null;
    let lastErr = null;

    // Attempt A (expected)
    {
      const { data, error } = await sb
        .from("portal_ledger")
        .select("created_at, entry_type, currency, amount_cents, amount_sats, reason, account_id")
        .in("account_id", accountIds)
        .order("created_at", { ascending:false })
        .limit(25);

      if(!error){ rows = data || []; }
      else { lastErr = error; }
    }

    // Attempt B fallback (some schemas use "type" instead of "entry_type")
    if(rows === null){
      const msg = String(lastErr?.message || "");
      if(msg.toLowerCase().includes("entry_type") || msg.toLowerCase().includes("column")){
        const { data, error } = await sb
          .from("portal_ledger")
          .select("created_at, type, currency, amount_cents, amount_sats, reason, account_id")
          .in("account_id", accountIds)
          .order("created_at", { ascending:false })
          .limit(25);

        if(!error){
          // normalize to entry_type
          rows = (data || []).map(r => ({ ...r, entry_type: r.type }));
          lastErr = null;
        } else {
          lastErr = error;
        }
      }
    }

    if(rows === null){
      body.innerHTML = `<tr><td colspan="5" style="color:var(--muted);">Ledger failed to load: ${esc(lastErr?.message || "Unknown error")}</td></tr>`;
      return;
    }

    if(!rows || rows.length === 0){
      body.innerHTML = `<tr><td colspan="5" style="color:var(--muted);">No transactions yet.</td></tr>`;
      return;
    }

    body.innerHTML = "";
    rows.forEach(r => {
      const dt = r.created_at ? new Date(r.created_at).toLocaleString() : "â€”";
      const desc = String(r.reason || "â€”");
      const typeRaw = String(r.entry_type || "â€”");
      const type = typeRaw.toLowerCase();
      const cur = String(r.currency || "â€”").toUpperCase();

      const creditLike = isCreditLike(typeRaw);
      const signedAmt = amountWithSign(cur, r.amount_cents, r.amount_sats, creditLike);

      const pill = (creditLike === true)
        ? `<span class="tx-pill credit">credit</span>`
        : (creditLike === false)
          ? `<span class="tx-pill debit">debit</span>`
          : `<span class="tx-pill">entry</span>`;

      const amtClass = (creditLike === true)
        ? "tx-amt tx-credit mono"
        : (creditLike === false)
          ? "tx-amt tx-debit mono"
          : "tx-amt mono";

      body.insertAdjacentHTML("beforeend", `
        <tr>
          <td>${esc(dt)}</td>
          <td>${esc(desc)}</td>
          <td>${pill} <span style="opacity:.85;margin-left:6px;">${esc(type)}</span></td>
          <td>${esc(cur)}</td>
          <td class="${amtClass}">${esc(signedAmt)}</td>
        </tr>
      `);
    });
  }

  async function refreshUI(profile, userId){
    const now = new Date();
    $("lastChecked").textContent = "Last checked: " + now.toLocaleString();

    const tier = (profile?.tier || profile?.selected_tier || "").toUpperCase();
    let qty = Number(profile?.qty || 0) || 0;

    if (tier === "BLACK") qty = 1;
    if (!Number.isFinite(qty) || qty < 1) qty = 1;

    $("tierCell").textContent = tier || "â€”";
    $("qtyCell").textContent = String(qty);

    const isActive = profile?.is_active === true;
    $("statusCell").textContent = isActive ? "Active" : "Pending";
    setBadge(isActive);

    if(isActive) unlockActions();
    else lockActions();

    const { data: accounts, error: accErr } = await getAccountsByUserId(userId);
    if(accErr){
      $("balance").textContent = "$0.00";
      $("btcBalance").textContent = "Balance blocked (RLS)";
      return;
    }

    await renderBalanceFromDb(tier, accounts || []);
  }

  $("sendBtn").addEventListener("click", () => {
    alert("Send is enabled for Active accounts. (Next step: build real Send flow.)");
  });
  $("receiveBtn").addEventListener("click", () => {
    alert("Receive is enabled for Active accounts. (Next step: build real Receive flow.)");
  });

  $("logoutBtn").addEventListener("click", async () => {
    say("Signing outâ€¦");
    try{ await sb.auth.signOut(); } catch {}
    hardToLogin();
  });

  // Manual refresh
  $("refreshBtn").addEventListener("click", async () => {
    try{
      $("refreshBtn").disabled = true;
      say("Refreshingâ€¦");
      const session = await getSessionOrKick();
      if(!session) return hardToLogin();
      const email = (session.user?.email || "").trim().toLowerCase();
      const userId = session.user?.id;
      if(!email || !userId) return hardToLogin();

      const { data: profile } = await getDbProfileByEmail(email);
      if(profile){
        const t2 = normTier(profile.tier) || normTier(profile.selected_tier);
        if(t2 === "gold") return window.location.replace("portal-gold.html");
        await refreshUI(profile, userId);
        await loadRecentTransactionsByUserId(userId);
      }
      say("Refreshed âœ…");
    } catch(e){
      say("Refresh error: " + (e?.message || e));
    } finally {
      $("refreshBtn").disabled = false;
    }
  });

  (async () => {
    try{
      say("Checking sessionâ€¦");
      const session = await getSessionOrKick();
      if(!session) return hardToLogin();

      const user = session.user || {};
      const verifiedAt = user.email_confirmed_at || user.confirmed_at || null;
      if(!verifiedAt){
        try{ await sb.auth.signOut(); } catch {}
        return window.location.replace("login.html?msg=verify_email");
      }

      const email = (user.email || "").trim().toLowerCase();
      const userId = user.id;
      if(!email || !userId) return hardToLogin();

      const name = pickNameFromUser(user);
      $("nameCell").textContent = name;
      const hello = $("helloName");
      if(hello){
        hello.style.display = "inline-flex";
        hello.textContent = "Hi, " + name;
      }

      $("emailCell").textContent = email;
      try{
        localStorage.setItem("qfsEmail", email);
        localStorage.setItem("memberEmail", email);
      } catch {}

      say("Fetching profileâ€¦");
      const { data: profile, error } = await getDbProfileByEmail(email);

      if(error){
        say("Profile SELECT blocked (RLS). portal_users read policy must allow this email.");
        lockActions();
        return;
      }

      if(!profile){
        say("No profile row â†’ registration");
        return window.location.replace("registration.html");
      }

      const effectiveTier = normTier(profile.tier) || normTier(profile.selected_tier);
      if(effectiveTier === "gold"){
        say("Gold detected â†’ redirect portal-gold.html");
        return window.location.replace("portal-gold.html");
      }

      await refreshUI(profile, userId);
      await loadRecentTransactionsByUserId(userId);
      say("Loaded âœ…");

      setInterval(async () => {
        const { data: p2 } = await getDbProfileByEmail(email);
        if(p2){
          const t2 = normTier(p2.tier) || normTier(p2.selected_tier);
          if(t2 === "gold") return window.location.replace("portal-gold.html");
          await refreshUI(p2, userId);
          await loadRecentTransactionsByUserId(userId);
        }
      }, 20000);

    } catch(e){
      say("Boot error: " + (e?.message || e));
    }
  })();
</script>

</body>
</html>
