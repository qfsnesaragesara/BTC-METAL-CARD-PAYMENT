<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Member Portal — QFS</title>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#071024; color:#e8eefc; }
    .top { display:flex; justify-content:space-between; align-items:center; padding:18px 24px; border-bottom:1px solid rgba(255,255,255,.08); }
    .wrap { max-width:1100px; margin:0 auto; padding:24px; }
    .pill { padding:6px 10px; border:1px solid rgba(255,255,255,.15); border-radius:999px; font-size:12px; }
    .pill.active { border-color: rgba(60,220,160,.35); background: rgba(60,220,160,.12); }
    .pill.inactive { border-color: rgba(255,80,80,.35); background: rgba(255,80,80,.12); }
    .grid { display:grid; grid-template-columns: 1.2fr .8fr; gap:18px; margin-top:18px; }
    .card { border-radius:16px; border:1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.05); padding:16px; }
    .big { font-size:34px; font-weight:800; margin:6px 0; }
    .muted { opacity:.75; font-size:12px; }
    button {
      cursor:pointer; padding:12px 14px; border-radius:12px;
      background: rgba(90,140,255,.25); border:1px solid rgba(90,140,255,.35); color:#e8eefc;
    }
    button:hover { background: rgba(90,140,255,.35); }
    .row { display:flex; gap:10px; align-items:center; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
  <div class="top">
    <div>
      <div style="font-weight:800">Member Portal</div>
      <div class="muted">QFS NESARA GESARA</div>
    </div>
    <div class="row">
      <span id="statusPill" class="pill">Checking…</span>
      <button id="btnLogout">Logout</button>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <div class="card">
        <div class="muted">Available Balance</div>
        <div class="big" id="bal">$0.00</div>
        <div class="muted" id="btcLine">—</div>

        <div class="row" style="margin-top:12px;">
          <button id="btnSend" disabled>Send</button>
          <button id="btnReceive" disabled>Receive</button>
        </div>

        <div class="card" style="margin-top:12px; padding:12px;">
          <div id="activeLine" class="muted">Loading…</div>
          <div class="muted" id="lastChecked"></div>
        </div>
      </div>

      <div class="card">
        <div style="font-weight:800; margin-bottom:10px;">Account Details</div>
        <div class="muted">Your Membership</div>
        <div style="margin-top:12px;">
          <div class="muted">NAME</div>
          <div id="nameVal">—</div>
          <div class="muted" style="margin-top:10px;">EMAIL</div>
          <div id="emailVal">—</div>
          <div class="muted" style="margin-top:10px;">TIER</div>
          <div id="tierVal">—</div>
          <div class="muted" style="margin-top:10px;">QUANTITY</div>
          <div id="qtyVal">—</div>
          <div class="muted" style="margin-top:10px;">STATUS</div>
          <div id="statusVal">—</div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:18px;">
      <div style="font-weight:800">Recent Transactions</div>
      <div class="muted">Your recent account activity</div>
      <div id="tx" class="muted" style="margin-top:12px;">Loading…</div>
    </div>
  </div>

  <script>
    // ========= CONFIG (fill these) =========
    const SUPABASE_URL = "YOUR_SUPABASE_URL";
    const SUPABASE_ANON_KEY = "YOUR_SUPABASE_ANON_KEY";
    // ======================================

    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const el = (id) => document.getElementById(id);
    const statusPill = el("statusPill");

    let session = null;

    async function ensureSessionReady() {
      const { data, error } = await sb.auth.getSession();
      if (error) throw error;
      session = data.session;
      if (!session) throw new Error("Not authenticated (no session).");
      return session;
    }

    function setActiveUI(isActive) {
      const pill = statusPill;
      pill.classList.remove("active", "inactive");
      if (isActive) {
        pill.textContent = "ACTIVE";
        pill.classList.add("active");
        el("btnSend").disabled = false;
        el("btnReceive").disabled = false;
        el("activeLine").textContent = "Account Active — Send & Receive are unlocked.";
        el("statusVal").textContent = "Active";
      } else {
        pill.textContent = "INACTIVE";
        pill.classList.add("inactive");
        el("btnSend").disabled = true;
        el("btnReceive").disabled = true;
        el("activeLine").textContent = "Account Inactive — Send & Receive are locked.";
        el("statusVal").textContent = "Inactive";
      }
      el("lastChecked").textContent = "Last checked: " + new Date().toLocaleString();
    }

    async function loadPortal() {
      await ensureSessionReady();

      const uid = session.user.id;
      const email = session.user.email;

      el("emailVal").textContent = email || "—";
      el("nameVal").textContent = session.user.user_metadata?.name || session.user.user_metadata?.full_name || "—";

      // pull the portal user row
      const { data: userRow, error } = await sb
        .from("portal_users")
        .select("id,email,tier,qty,is_active")
        .eq("id", uid)
        .maybeSingle();

      if (error) throw error;

      el("tierVal").textContent = userRow?.tier || "—";
      el("qtyVal").textContent = (userRow?.qty ?? "—");
      setActiveUI(!!userRow?.is_active);

      // balances via RPC (if you have it)
      const { data: bal, error: balErr } = await sb.rpc("get_my_balances");
      if (!balErr && bal) {
        const usd = Number(bal.usd_cents || 0) / 100;
        el("bal").textContent = usd.toLocaleString(undefined, { style:"currency", currency:"USD" });
        el("btcLine").textContent = `≈ ${Number(bal.btc_sats || 0).toLocaleString()} sats (live BTC price)`;
      }

      // recent ledger via RPC (optional)
      const { data: tx, error: txErr } = await sb.rpc("get_my_ledger", { p_limit: 10 });
      if (txErr || !tx) {
        el("tx").textContent = "—";
      } else if (tx.length === 0) {
        el("tx").textContent = "No transactions.";
      } else {
        el("tx").innerHTML = tx.map(x => {
          const amt = x.currency === "USD"
            ? (Number(x.amount_cents || 0) / 100).toLocaleString(undefined, { style:"currency", currency:"USD" })
            : `${Number(x.amount_sats || 0).toLocaleString()} sats`;
          return `<div class="muted">${x.created_at} — ${x.entry_type} — ${x.currency} ${amt}</div>`;
        }).join("");
      }
    }

    async function logout() {
      await sb.auth.signOut();
      statusPill.textContent = "Logged out";
    }

    el("btnLogout").addEventListener("click", logout);

    sb.auth.onAuthStateChange(async (_event, _session) => {
      session = _session;
      if (!session) {
        statusPill.textContent = "Not logged in";
        return;
      }
      try {
        await loadPortal();
      } catch (e) {
        statusPill.textContent = "ERROR";
        console.error(e);
      }
    });

    (async () => {
      try {
        statusPill.textContent = "Checking…";
        await loadPortal();
      } catch (e) {
        statusPill.textContent = "Not logged in";
        console.error(e);
      }
    })();
  </script>
</body>
</html>
