<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Member Portal â€” QFS</title>
<meta name="robots" content="noindex, nofollow">
<link rel="icon" type="image/png" href="https://github.com/qfsnesaragesara/BTC-METAL-CARD-PAYMENT/blob/main/photo%201.jpg?raw=true" />

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  :root{
    --bg:#020617;
    --text:#e5e7eb;
    --muted:#9ca3af;
    --accent:#38bdf8;
    --accent2:#a855f7;
    --glass:rgba(15,23,42,0.88);
    --border:rgba(148,163,184,0.45);
    --shadow:rgba(2,6,23,0.9);
    --radius:18px;
    --maxw:1100px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    min-height:100vh;
    padding:24px;
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    color:var(--text);
    background:
      radial-gradient(circle at top, rgba(56,189,248,0.30), transparent 55%),
      radial-gradient(circle at bottom, rgba(147,51,234,0.32), transparent 60%),
      var(--bg);
  }

  .wrap{ max-width:var(--maxw); margin:0 auto; }

  .header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:14px;
    margin-bottom:18px;
  }
  .brand{ display:flex; align-items:center; gap:12px; }
  .logo{
    width:54px; height:54px;
    border-radius:14px;
    object-fit:cover;
    box-shadow:
      0 14px 44px rgba(2,6,23,0.95),
      0 0 0 1px rgba(148,163,184,0.35);
  }
  .brand h1{
    margin:0;
    font-size:18px;
    font-weight:900;
    letter-spacing:-0.02em;
  }
  .brand span{ font-size:12px; color:var(--muted); }

  .header-actions{
    display:flex;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
    justify-content:flex-end;
  }
  .pill{
    padding:8px 12px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,0.35);
    background:rgba(255,255,255,0.06);
    color:var(--text);
    font-weight:850;
    font-size:12px;
    text-decoration:none;
    display:inline-flex;
    align-items:center;
    gap:8px;
  }
  .badge{
    padding:6px 10px;
    border-radius:999px;
    font-size:11px;
    font-weight:900;
    letter-spacing:0.06em;
    text-transform:uppercase;
    border:1px solid rgba(148,163,184,0.30);
    background:rgba(2,6,23,0.40);
    color:#e5e7eb;
  }
  .badge.pending{ border-color: rgba(251,191,36,0.35); color:#fde68a; }
  .badge.active{ border-color: rgba(34,197,94,0.35); color:#bbf7d0; }
  .badge.rejected{ border-color: rgba(244,63,94,0.35); color:#fecdd3; }

  .grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:18px;
  }
  @media (max-width:860px){ .grid{ grid-template-columns:1fr; } }

  .card{
    background:linear-gradient(145deg, rgba(15,23,42,0.96), rgba(15,23,42,0.84));
    border:1px solid var(--border);
    border-radius:28px;
    padding:20px;
    box-shadow: 0 28px 110px var(--shadow);
    backdrop-filter: blur(26px);
    position:relative;
    overflow:hidden;
  }
  .card:before{
    content:"";
    position:absolute;
    inset:-120px -120px auto auto;
    width:320px;
    height:320px;
    background: radial-gradient(circle at center, rgba(56,189,248,0.18), transparent 60%);
    pointer-events:none;
  }

  .card h2{ margin:0 0 6px; font-size:16px; font-weight:900; }
  .sub{ font-size:12px; color:var(--muted); }

  .balance{
    font-size:34px;
    font-weight:900;
    margin:12px 0 4px;
    background:linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
  }
  .btc{
    font-size:13px;
    color:#cbd5f5;
    line-height:1.55;
  }

  .actions{ display:flex; gap:12px; margin-top:14px; flex-wrap:wrap; }
  .btn{
    flex:1;
    padding:12px 14px;
    border-radius:999px;
    border:none;
    cursor:pointer;
    font-weight:900;
    font-size:13px;
    letter-spacing:0.04em;
  }
  .btn-primary{
    background:linear-gradient(135deg, var(--accent), var(--accent2));
    color:#fff;
  }
  .btn-disabled{
    background:rgba(255,255,255,0.06);
    border:1px dashed rgba(148,163,184,0.45);
    color:var(--muted);
    cursor:not-allowed;
  }

  .status{
    margin-top:10px;
    padding:10px 12px;
    border-radius:14px;
    background:rgba(2,6,23,0.45);
    border:1px solid rgba(148,163,184,0.35);
    font-size:12px;
  }

  table{
    width:100%;
    border-collapse:collapse;
    margin-top:10px;
    font-size:12px;
  }
  th, td{
    padding:10px 8px;
    border-bottom:1px solid rgba(148,163,184,0.2);
    text-align:left;
  }
  th{
    color:var(--muted);
    font-weight:700;
    text-transform:uppercase;
    font-size:11px;
  }

  .mutedline{ color:var(--muted); font-size:12px; margin-top:8px; }
</style>
</head>

<body>
<div class="wrap">

  <header class="header">
    <div class="brand">
      <img class="logo"
        src="https://github.com/qfsnesaragesara/BTC-METAL-CARD-PAYMENT/blob/main/photo%201.jpg?raw=true"
        alt="QFS NESARA GESARA" />
      <div>
        <h1>Member Portal</h1>
        <span>QFS NESARA GESARA</span>
      </div>
    </div>

    <div class="header-actions">
      <span id="statusBadge" class="badge pending">Pending</span>
      <a class="pill" href="login.html" id="logoutLink">Logout</a>
    </div>
  </header>

  <section class="grid">

    <div class="card">
      <h2>Available Balance</h2>
      <div class="sub">Balance becomes active after you order your access card</div>

      <div class="balance" id="balance">$0.00</div>
      <div class="btc" id="btcBalance">â€”</div>

      <div class="actions">
        <button id="sendBtn" class="btn btn-disabled" disabled>Send</button>
        <button id="receiveBtn" class="btn btn-disabled" disabled>Receive</button>
      </div>

      <div class="status" id="lockNote">
        ðŸ”’ Send & Receive are locked until you activate your access card.
      </div>

      <div class="mutedline" id="lastChecked">Checking confirmationâ€¦</div>
    </div>

    <div class="card">
      <h2>Account Details</h2>
      <div class="sub">Your Membership Balance</div>

      <table>
        <tr>
          <th>Email</th>
          <td id="emailCell">â€”</td>
        </tr>
        <tr>
          <th>Tier</th>
          <td id="tierCell">â€”</td>
        </tr>
        <tr>
          <th>Quantity</th>
          <td id="qtyCell">â€”</td>
        </tr>
        <tr>
          <th>Status</th>
          <td id="statusCell">Pending</td>
        </tr>
      </table>

    </div>

    <div class="card" style="grid-column:1 / -1;">
      <h2>Recent Activity</h2>
      <div class="sub">Transactions will appear after activation</div>

      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Type</th>
            <th>Amount</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td colspan="4" style="color:var(--muted);">No activity yet</td>
          </tr>
        </tbody>
      </table>
    </div>

  </section>
</div>

<script>
  /*********************************************************
   * CONFIG â€” Supabase credentials
   *********************************************************/
  const SUPABASE_URL = "https://qagktukzxtwbjrdgiben.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFhZ2t0dWt6eHR3YmpyZGdpYmVuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4NDA0NTQsImV4cCI6MjA4MzQxNjQ1NH0.cbhSWHGlmhmIt-NmUVBUtAhPpNPDKk4Bz-Gy1TbPzHk";

  /*********************************************************
   * Helpers
   *********************************************************/
  const $ = (id) => document.getElementById(id);
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  let email =
    localStorage.getItem("qfsEmail") ||
    localStorage.getItem("memberEmail") ||
    "";

  // DB truth (from portal_users)
  let __profileTier = "";
  let __profileQty = 0;
  let __effectiveTier = "";

  function normTier(v){
    const s = (v || "").toString().trim().toLowerCase();
    return (s === "gold" || s === "silver" || s === "black") ? s : "";
  }

  function inferTierFromText(txt){
    const s = (txt || "").toString().toLowerCase();
    if(s.includes("gold")) return "gold";
    if(s.includes("silver")) return "silver";
    if(s.includes("black")) return "black";
    return "";
  }

  function inferTierFromUser(user){
    // 1) metadata from signup
    const meta = user?.user_metadata || {};
    const registeringFor = meta.registering_for || meta.registeringFor || "";
    let tier = inferTierFromText(registeringFor);

    // 2) local storage fallback
    if(!tier){
      const ls = localStorage.getItem("qfs_registering_for") || "";
      tier = inferTierFromText(ls);
    }

    // 3) last resort default
    if(!tier) tier = "silver";

    return tier;
  }

  function fmtUSD(n){
    return "$" + Number(n).toLocaleString(undefined, { maximumFractionDigits: 2 });
  }

  async function fetchBtcUsd(){
    try{
      const r = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd");
      const j = await r.json();
      return Number(j?.bitcoin?.usd || 0);
    } catch {
      return 0;
    }
  }

  function setBadge(status){
    const b = $("statusBadge");
    b.classList.remove("pending","active","rejected");
    if(status === "confirmed"){
      b.textContent = "Active";
      b.classList.add("active");
    } else if(status === "rejected"){
      b.textContent = "Rejected";
      b.classList.add("rejected");
    } else {
      b.textContent = "Pending";
      b.classList.add("pending");
    }
  }

  function lockActions(){
    $("sendBtn").disabled = true;
    $("receiveBtn").disabled = true;
    $("sendBtn").classList.add("btn-disabled");
    $("receiveBtn").classList.add("btn-disabled");
    $("sendBtn").classList.remove("btn-primary");
    $("receiveBtn").classList.remove("btn-primary");
    $("lockNote").textContent = "ðŸ”’ Send & Receive are locked until you activate your access card.";
  }

  function unlockActions(){
    $("sendBtn").disabled = false;
    $("receiveBtn").disabled = false;

    $("sendBtn").classList.remove("btn-disabled");
    $("receiveBtn").classList.remove("btn-disabled");

    $("sendBtn").classList.add("btn-primary");
    $("receiveBtn").classList.add("btn-primary");

    $("lockNote").textContent = "âœ… Account Active â€” Send & Receive are unlocked.";
  }

  function setAllocationUI(tierUpper, qty){
    const tier = (tierUpper || "").toUpperCase();
    $("tierCell").textContent = tier || "â€”";
    $("qtyCell").textContent = qty ? String(qty) : "â€”";

    $("balance").textContent = "$0.00";
    $("btcBalance").textContent = "â€”";

    if(tier === "SILVER"){
      const usdBalance = 25000 * qty;
      $("balance").textContent = fmtUSD(usdBalance);
      $("btcBalance").textContent = "â‰ˆ $25,000 per card allocation";
    }

    if(tier === "BLACK"){
      $("balance").textContent = "25,000 BTC";
      $("btcBalance").textContent = "USD equivalent loadingâ€¦";
    }
  }

  function setBlackUsdEquivalent(btcUsd){
    if(!btcUsd) {
      $("btcBalance").textContent = "USD equivalent unavailable";
      return;
    }
    const usdEq = 25000 * btcUsd;
    $("btcBalance").textContent = "â‰ˆ " + fmtUSD(usdEq) + " (live BTC price)";
  }

  /*********************************************************
   * âœ… HARD GATE â€” require login + verified email
   *********************************************************/
  async function requireSessionAndVerified(){
    const { data, error } = await sb.auth.getSession();
    const session = data?.session || null;

    if(error || !session){
      window.location.replace("login.html");
      return null;
    }

    const user = session.user || {};
    const verifiedAt = user.email_confirmed_at || user.confirmed_at || null;

    email = user.email || email || "";
    if(email){
      localStorage.setItem("qfsEmail", email);
      localStorage.setItem("memberEmail", email);
      $("emailCell").textContent = email;
    } else {
      $("emailCell").textContent = "â€”";
    }

    if(!verifiedAt){
      try{
        $("btcBalance").textContent = "âš ï¸ Please verify your email before accessing the portal. Redirecting to loginâ€¦";
        await sb.auth.signOut();
      } catch {}
      setTimeout(() => window.location.replace("login.html?msg=verify_email"), 900);
      return null;
    }

    return session;
  }

  /*********************************************************
   * âœ… DB TRUTH ONLY â€” portal_users drives tier + routing
   *    + Auto-provision portal_users row if missing
   *********************************************************/
  async function loadDbProfileAndRoute(session){
    try{
      const user = session?.user || {};
      if(!user?.id){
        window.location.replace("login.html");
        return false;
      }

      // Try fetch profile (truth)
      let { data: profile, error } = await sb
        .from("portal_users")
        .select("email, tier, selected_tier, is_active, card_qty, is_activated")
        .eq("id", user.id)
        .single();

      // If missing: auto-create profile
      if(error || !profile){
        const inferred = inferTierFromUser(user);
        const dbEmail = (user.email || email || "").trim().toLowerCase();

        const newRow = {
          id: user.id,
          email: dbEmail || null,
          tier: inferred,              // IMPORTANT: tier is NOT NULL in your table
          selected_tier: inferred,
          card_qty: inferred === "silver" ? 1 : 1, // safe default
          is_active: false,
          is_activated: false
        };

        const { data: created, error: insErr } = await sb
          .from("portal_users")
          .insert(newRow)
          .select("email, tier, selected_tier, is_active, card_qty, is_activated")
          .single();

        if(insErr || !created){
          // If RLS blocks insert, send them to registration to complete profile manually
          window.location.replace("registration.html?msg=profile_missing");
          return false;
        }

        profile = created;
      }

      // Email from DB is best truth
      const dbEmail = (profile.email || user.email || "").trim();
      if(dbEmail){
        email = dbEmail;
        localStorage.setItem("qfsEmail", email);
        localStorage.setItem("memberEmail", email);
        $("emailCell").textContent = email;
      }

      const tier = normTier(profile.tier);
      const selected = normTier(profile.selected_tier);
      const isActive = profile.is_active === true;

      // Active -> tier; Not active -> selected_tier (fallback to tier)
      __effectiveTier = isActive ? (tier || selected) : (selected || tier);

      // Cache for UI
      __profileTier = (__effectiveTier || tier || selected || "").toUpperCase();
      __profileQty = Number(profile.card_qty || 0) || 0;

      // Gold -> move to gold portal
      if(__effectiveTier === "gold"){
        window.location.replace("portal-gold.html");
        return false;
      }

      // If you enforce activation, keep it:
      if(profile.is_activated === false){
        window.location.replace("pending.html");
        return false;
      }

      return true;
    } catch {
      window.location.replace("login.html");
      return false;
    }
  }

  /*********************************************************
   * Main â€” auto-check admin confirmation
   *********************************************************/
  async function checkStatusAndUpdateUI(){
    const now = new Date();
    $("lastChecked").textContent = "Last checked: " + now.toLocaleString();

    const params = new URLSearchParams(location.search);
    let fallbackTier = (params.get("tier") || params.get("type") || "").toUpperCase();
    let fallbackQty = Number(params.get("qty") || 1);

    // Prefer DB tier/qty when present
    if(__profileTier) fallbackTier = __profileTier;
    if(__profileQty) fallbackQty = __profileQty;

    if(fallbackTier === "BLACK") fallbackQty = 1;
    if(fallbackTier === "SILVER" && fallbackQty > 50) fallbackQty = 50;
    if(!Number.isFinite(fallbackQty) || fallbackQty < 1) fallbackQty = 1;

    lockActions();
    setBadge("pending");
    $("statusCell").textContent = "Pending";

    setAllocationUI(fallbackTier, fallbackQty);

    if(!email){
      $("btcBalance").textContent = "Login email not found. Please login again.";
      return;
    }

    try{
      // Keep existing payment_submissions logic for unlocking Send/Receive
      const { data, error } = await sb
        .from("payment_submissions")
        .select("status, card_type, qty, created_at")
        .ilike("email", email)
        .order("created_at", { ascending:false })
        .limit(1);

      if(error) throw error;

      const row = (data && data[0]) ? data[0] : null;

      if(!row){
        $("statusCell").textContent = "Pending";
        setBadge("pending");
        lockActions();
      } else {
        const status = (row.status || "pending").toLowerCase();
        const tier = (row.card_type || fallbackTier || "").toUpperCase();
        let qty = Number(row.qty || fallbackQty || 1);

        if(tier === "BLACK") qty = 1;
        if(tier === "SILVER" && qty > 50) qty = 50;
        if(!Number.isFinite(qty) || qty < 1) qty = 1;

        $("statusCell").textContent =
          status === "confirmed" ? "Active" : (status === "rejected" ? "Rejected" : "Pending");

        setBadge(status);
        setAllocationUI(tier, qty);

        if(status === "confirmed"){
          unlockActions();
        } else {
          lockActions();
        }
      }

      const tierShown = ($("tierCell").textContent || "").toUpperCase();
      if(tierShown === "BLACK"){
        const btcUsd = await fetchBtcUsd();
        setBlackUsdEquivalent(btcUsd);
      } else if(tierShown === "SILVER"){
        const btcUsd = await fetchBtcUsd();
        if(btcUsd){
          const qtyShown = Number($("qtyCell").textContent || 1);
          const usdBal = 25000 * (Number.isFinite(qtyShown) ? qtyShown : 1);
          const btcEq = usdBal / btcUsd;
          $("btcBalance").textContent = `â‰ˆ ${btcEq.toFixed(8)} BTC (live BTC price)`;
        }
      }

    } catch(e){
      setBadge("pending");
      $("statusCell").textContent = "Pending";
      lockActions();
    }
  }

  $("sendBtn").addEventListener("click", () => {
    alert("Send is enabled for Active accounts. (Next step: build real Send flow.)");
  });
  $("receiveBtn").addEventListener("click", () => {
    alert("Receive is enabled for Active accounts. (Next step: build real Receive flow.)");
  });

  $("logoutLink").addEventListener("click", async (e) => {
    e.preventDefault();
    try{ await sb.auth.signOut(); } catch {}
    window.location.href = "login.html";
  });

  (async () => {
    const session = await requireSessionAndVerified();
    if(!session) return;

    const ok = await loadDbProfileAndRoute(session);
    if(!ok) return;

    $("emailCell").textContent = email || "â€”";
    await checkStatusAndUpdateUI();
    setInterval(checkStatusAndUpdateUI, 20000);
  })();
</script>
</body>
</html>
