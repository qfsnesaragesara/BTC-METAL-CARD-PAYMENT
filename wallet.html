<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Wallet — Complete Payment</title>

<!-- QR library -->
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>

<style>
  :root{
    --bg:#020617;
    --card:#020617;
    --muted:#9ca3af;
    --accent:#38bdf8;
    --accent-soft:rgba(56,189,248,0.35);
    --gold:#fbbf24;
    --glass:rgba(15,23,42,0.9);
    --radius:18px;
    --maxw:960px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: Inter, system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    background:
      radial-gradient(circle at top, rgba(56,189,248,0.32), transparent 55%),
      radial-gradient(circle at bottom, rgba(147,51,234,0.35), transparent 60%),
      var(--bg);
    color:#e5e7eb;
    padding:24px;
    display:flex;
    justify-content:center;
  }

  .page {
    width:100%;
    max-width:var(--maxw);
    display:flex;
    gap:22px;
    align-items:flex-start;
    flex-wrap:wrap;
  }

  /* LEFT: QR + info */
  .left {
    flex:1 1 560px;
    display:flex;
    flex-direction:column;
    gap:20px;
    align-items:center;
  }

  .step-header {
    text-align:center;
    margin-bottom:-10px;
  }
  .step-header .step {
    font-size:13px;
    font-weight:700;
    letter-spacing:0.12em;
    text-transform:uppercase;
    color:#38bdf8;
    opacity:0.85;
  }
  .step-header .secure {
    font-size:11px;
    margin-top:6px;
    color:#9ca3af;
    letter-spacing:0.04em;
  }

  .card {
    width:100%;
    max-width:460px;
    padding:22px 22px 20px;
    border-radius:26px;
    background:linear-gradient(145deg, rgba(15,23,42,0.96), rgba(15,23,42,0.86));
    box-shadow:
      0 28px 90px rgba(15,23,42,0.98),
      0 0 0 1px rgba(15,23,42,0.9);
    border:1px solid rgba(148,163,184,0.6);
    backdrop-filter: blur(26px);
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:14px;
  }

  /* glowing QR frame */
  .qr-wrap {
    padding:18px;
    border-radius:22px;
    background:radial-gradient(circle at top, rgba(56,189,248,0.25), rgba(15,23,42,0.98));
    position:relative;
    box-shadow:
      0 24px 70px rgba(15,23,42,1),
      0 0 36px rgba(56,189,248,0.28);
  }

  .qr-frame {
    border-radius:16px;
    padding:14px;
    background:#020617;
    box-shadow:0 16px 50px rgba(15,23,42,0.9);
  }

  .qr-wrap::after {
    content:"";
    position:absolute;
    inset:-10px;
    border-radius:26px;
    background:
      radial-gradient(ellipse at top, rgba(56,189,248,0.32), transparent 55%),
      radial-gradient(ellipse at bottom, rgba(147,51,234,0.36), transparent 60%);
    filter: blur(18px);
    opacity:0.95;
    animation: glow 3.2s ease-in-out infinite;
  }

  @keyframes glow {
    0%{ transform:scale(0.97); opacity:0.8;}
    50%{ transform:scale(1.02); opacity:1;}
    100%{ transform:scale(0.97); opacity:0.8;}
  }

  /* payment details */
  .info-row{
    width:100%;
    display:flex;
    justify-content:space-between;
    gap:12px;
    align-items:center;
  }
  .label {
    color:var(--muted);
    font-size:12px;
    text-transform:uppercase;
    letter-spacing:0.08em;
  }
  .value {
    font-weight:800;
    font-size:18px;
    color:#f9fafb;
  }
  .value.small {
    font-size:13px;
    font-weight:600;
    color:#cbd5f5;
  }

  .small {
    font-size:12px;
    color:var(--muted);
  }

  /* RIGHT SIDE PANEL */
  .right {
    width:320px;
    min-width:260px;
    background:linear-gradient(145deg, rgba(15,23,42,0.98), rgba(15,23,42,0.9));
    border-radius:24px;
    padding:20px 18px 22px;
    border:1px solid rgba(148,163,184,0.6);
    box-shadow:
      0 28px 90px rgba(15,23,42,1),
      0 0 0 1px rgba(15,23,42,0.95);
    backdrop-filter: blur(28px);
    display:flex;
    flex-direction:column;
    gap:12px;
  }

  .heading {
    font-size:18px;
    font-weight:780;
    letter-spacing:0.06em;
    text-transform:uppercase;
  }
  .muted {
    color:var(--muted);
    font-size:13px;
  }

  .addr-box {
    padding:10px 11px;
    border-radius:14px;
    background:radial-gradient(circle at top, rgba(148,163,184,0.24), rgba(15,23,42,1));
    border:1px solid rgba(148,163,184,0.7);
    font-family:monospace;
    word-break:break-all;
    font-size:13px;
  }

  .actions {
    display:flex;
    gap:10px;
  }

  .btn {
    flex:1;
    padding:10px 12px;
    border-radius:999px;
    border:none;
    cursor:pointer;
    font-weight:700;
    font-size:13px;
    letter-spacing:0.08em;
    text-transform:uppercase;
  }

  .btn-copy {
    background:radial-gradient(circle at top left, #3b82f6, #38bdf8);
    color:#f9fafb;
    box-shadow:
      0 16px 40px rgba(56,189,248,0.45),
      0 0 0 1px rgba(15,23,42,1);
    transition:transform 0.16s ease-out, box-shadow 0.16s ease-out, filter 0.16s ease-out;
  }
  .btn-copy:hover {
    transform:translateY(-1px);
    filter:brightness(1.05);
  }

  /* payment window */
  .pending {
    margin-top:10px;
    padding:12px;
    border-radius:18px;
    background:linear-gradient(145deg, rgba(22,163,74,0.12), rgba(15,23,42,0.98));
    border:1px solid rgba(34,197,94,0.35);
    display:flex;
    gap:12px;
    align-items:center;
  }

  .loader {
    width:34px; height:34px; border-radius:50%;
    border:4px solid rgba(34,197,94,0.18);
    border-top-color:#22c55e;
    animation:spin 1s linear infinite;
  }
  @keyframes spin { 100%{ transform:rotate(360deg); } }

  .timer {
    font-weight:800;
    font-size:18px;
    color:#e5e7eb;
  }

  .center { text-align:center; }
  .linkless { text-decoration:none; color:inherit; }

  /* Buttons */
  .btn-secondary {
    background:radial-gradient(circle at top left, rgba(148,163,184,0.3), rgba(15,23,42,1));
    border:1px solid rgba(148,163,184,0.7);
    color:#e5e7eb;
  }

  .btn-primary {
    background:linear-gradient(135deg,#38bdf8,#a855f7);
    color:#f9fafb;
    box-shadow:
      0 20px 55px rgba(56,189,248,0.55),
      0 0 0 1px rgba(15,23,42,1);
  }

  @media (max-width:960px){
    .page{
      flex-direction:column;
      align-items:center;
      gap:18px;
    }
    .right{
      width:100%;
      max-width:480px;
    }
    .card{
      width:100%;
      max-width:480px;
    }
  }
</style>
</head>
<body>

<div class="page" role="main">

  <!-- LEFT -->
  <div class="left">

    <div class="step-header">
      <div class="step">Step 2 of 2: Complete Payment</div>
      <div class="secure">Secure • On-chain verified</div>
    </div>

    <div class="card" aria-live="polite">

      <div class="center small">Scan with your Bitcoin wallet and pay exactly the amount shown.</div>

      <div class="qr-wrap">
        <div class="qr-frame" id="qrFrame">
          <div id="qrCanvas" style="width:260px;height:260px;display:flex;align-items:center;justify-content:center"></div>
        </div>
      </div>

      <div style="width:100%;display:flex;flex-direction:column;gap:8px;">
        <div class="info-row">
          <div class="label">Amount (USD)</div>
          <div class="value" id="usdAmt">—</div>
        </div>
        <div class="info-row">
          <div class="label">Amount (BTC)</div>
          <div class="value" id="btcAmt">—</div>
        </div>
        <div class="info-row">
          <div class="label">To Wallet</div>
          <div class="value small" id="addrShort">—</div>
        </div>
      </div>

      <div id="awaiting" class="pending" style="display:none;">
        <div class="loader"></div>
        <div>
          <div style="font-weight:800;font-size:14px;">Awaiting Confirmation…</div>
          <div class="small">Network confirmations are being monitored automatically.</div>
        </div>
      </div>

      <div class="center small">Paid with wrong amount or currency? Contact support with TXID.</div>
    </div>

  </div>

  <!-- RIGHT -->
  <aside class="right">

    <div>
      <div class="heading">Order Summary</div>
      <div class="muted" id="summaryType">Loading…</div>
    </div>

    <div>
      <div class="label">Quantity</div>
      <div class="value" id="summaryQty">—</div>
    </div>

    <div>
      <div class="label">Total (USD)</div>
      <div class="value" id="summaryUSD">—</div>
    </div>

    <div>
      <div class="label">Total (BTC)</div>
      <div class="value" id="summaryBTC">—</div>
    </div>

    <div>
      <div class="label">Wallet Address</div>
      <div class="addr-box" id="walletAddr">—</div>
    </div>

    <div class="actions">
      <button id="copyBtn" class="btn btn-copy">Copy Address</button>
    </div>

    <div style="margin-top:10px;">
      <div class="label">Payment window</div>
      <div class="timer" id="payTimer">15:00</div>
      <div class="small">Complete payment within the time shown to reserve your price.</div>
    </div>

    <div style="margin-top:10px; display:flex; gap:8px;">
      <a id="backToOrder" class="linkless" href="#">
        <button class="btn btn-secondary">Back to Order</button>
      </a>
      <button id="paidBtn" class="btn btn-primary">I Have Paid</button>
    </div>

  </aside>

</div>

<script>
/* ========== Configuration ========== */
const DEFAULT_WALLET = "bc1qqla2r8dmmvefq9svus0kv098nnvudsehpzmut8";
const PAYMENT_WINDOW_SECONDS = 15 * 60;

let endTs = null;

/* Utility */
function qs(key){ return new URLSearchParams(location.search).get(key); }

const fmtUSD = n => "$" + Number(n).toLocaleString(undefined,{maximumFractionDigits:0});
const to8   = n => Number(n).toFixed(8);

/* Elements */
const usdEl        = document.getElementById("usdAmt");
const btcEl        = document.getElementById("btcAmt");
const addrShort    = document.getElementById("addrShort");
const walletAddrEl = document.getElementById("walletAddr");
const summaryType  = document.getElementById("summaryType");
const summaryQty   = document.getElementById("summaryQty");
const summaryUSD   = document.getElementById("summaryUSD");
const summaryBTC   = document.getElementById("summaryBTC");
const copyBtn      = document.getElementById("copyBtn");
const backToOrder  = document.getElementById("backToOrder");
const paidBtn      = document.getElementById("paidBtn");
const awaiting     = document.getElementById("awaiting");
const payTimer     = document.getElementById("payTimer");
const qrCanvas     = document.getElementById("qrCanvas");

/* Params */
let cardType = qs("type") || "gold";
let qty      = Number(qs("qty") || 1);
let usd      = Number(qs("usd") || 0);
let btc      = qs("btc") || "";
let addr     = qs("addr") || DEFAULT_WALLET;

/* Summary fields */
summaryType.innerText = cardType[0].toUpperCase() + cardType.slice(1) + " Card";
summaryQty.innerText  = qty;
summaryUSD.innerText  = usd ? fmtUSD(usd) : "—";
summaryBTC.innerText  = btc ? (to8(Number(btc)) + " BTC") : "—";
walletAddrEl.innerText = addr;
addrShort.innerText    = addr.slice(0,8) + "…" + addr.slice(-8);

/* Back link */
backToOrder.href =
  "order.html?type=" + cardType +
  "&qty=" + qty +
  "&usd=" + usd +
  "&btc=" + btc +
  "&addr=" + addr;

/* Compute BTC if needed */
async function ensureBtcAmount(){
  if(btc) return Number(btc);
  if(!usd) return null;

  try {
    const r = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd");
    const j = await r.json();
    const price = j.bitcoin.usd;
    return usd / price;
  } catch(e){
    return null;
  }
}

/* Build BTC URI */
function makeBitcoinURI(address, btcAmt){
  const s = Number(btcAmt).toFixed(8).replace(/\.?0+$/,"");
  return `bitcoin:${address}?amount=${s}`;
}

/* Draw QR */
async function drawQR(uri){
  qrCanvas.innerHTML = "";
  await QRCode.toCanvas(uri, { width:260, margin:1 }, (err,canvas)=>{
    if(err){
      qrCanvas.textContent="QR unavailable";
      return;
    }
    qrCanvas.appendChild(canvas);
  });
}

/* Payment timer */
const TIMER_KEY = "qfs_payment_" + btoa(addr + usd).slice(0,24);

function initPaymentWindow(){
  const stored = localStorage.getItem(TIMER_KEY);
  if(stored){
    endTs = Number(stored);
  } else {
    endTs = Date.now() + PAYMENT_WINDOW_SECONDS*1000;
    localStorage.setItem(TIMER_KEY, endTs);
  }
}

function runPaymentTimer(){
  const diff = endTs - Date.now();
  if(diff <= 0){
    payTimer.innerText = "00:00";
    paidBtn.disabled = true;
    copyBtn.disabled = false;
    return;
  }
  const mm = Math.floor(diff / 60000);
  const ss = Math.floor((diff % 60000)/1000);
  payTimer.innerText = `${String(mm).padStart(2,"0")}:${String(ss).padStart(2,"0")}`;
}

function showAwaiting(){
  awaiting.style.display = "flex";
}

/* Copy wallet */
copyBtn.onclick = () => {
  navigator.clipboard.writeText(addr).then(() => {
    const original = copyBtn.innerText;
    copyBtn.innerText = "Copied!";
    setTimeout(() => copyBtn.innerText = original, 1500);
  });
};

/* Paid button */
paidBtn.onclick = ()=>{
  showAwaiting();
  paidBtn.disabled = true;
  paidBtn.style.opacity = 0.6;

  setTimeout(() => {
    window.location.href = "confirmation-page.html";
  }, 1200);
};

/* INIT */
async function init(){
  const computed = await ensureBtcAmount();
  if(computed){
    const val = to8(computed);
    btc = val;
    btcEl.innerText = val + " BTC";
    summaryBTC.innerText = val + " BTC";
  }

  usdEl.innerText = usd ? fmtUSD(usd) : "—";

  const uri = makeBitcoinURI(addr, btc);
  await drawQR(uri);

  initPaymentWindow();
  runPaymentTimer();
  setInterval(runPaymentTimer, 1000);
}

init();
</script>

</body>
</html>
