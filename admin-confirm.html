<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Confirm — QFS</title>
  <meta name="robots" content="noindex, nofollow">
  <link rel="icon" type="image/png" href="https://github.com/qfsnesaragesara/BTC-METAL-CARD-PAYMENT/blob/main/photo%201.jpg?raw=true">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#020617;
      --glass1:rgba(15,23,42,0.78);
      --glass2:rgba(15,23,42,0.92);
      --border:rgba(148,163,184,0.42);
      --muted:#94a3b8;
      --text:#e5e7eb;
      --accent:#38bdf8;
      --accent2:#a855f7;
      --gold:#fbbf24;
      --emerald:#22c55e;
      --rose:#fb7185;
      --shadow: 0 28px 90px rgba(2,6,23,0.70);
      --radius:26px;
      --maxw:1120px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 480px at 15% 8%, rgba(56,189,248,0.22), transparent 55%),
        radial-gradient(900px 480px at 85% 85%, rgba(168,85,247,0.22), transparent 55%),
        radial-gradient(700px 360px at 75% 10%, rgba(251,191,36,0.10), transparent 55%),
        var(--bg);
      padding:22px;
      display:flex;
      justify-content:center;
      overflow-x:hidden;
    }
    .page{ width:100%; max-width:var(--maxw); display:flex; flex-direction:column; gap:14px; }
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px 14px;
      border:1px solid var(--border);
      border-radius:22px;
      background: linear-gradient(145deg, rgba(15,23,42,0.90), rgba(15,23,42,0.72));
      backdrop-filter: blur(26px);
      box-shadow: var(--shadow);
    }
    .brand{ display:flex; gap:12px; align-items:center; }
    .brand img{
      width:46px; height:46px; border-radius:14px; object-fit:cover;
      border:1px solid rgba(255,255,255,0.16);
      box-shadow:0 18px 38px rgba(56,189,248,0.18);
    }
    .brand .t1{ font-weight:950; letter-spacing:0.08em; font-size:12px; text-transform:uppercase; color: rgba(226,232,240,0.92); }
    .brand .t2{ margin-top:2px; color:rgba(148,163,184,0.95); font-size:12px; }

    .btn{
      padding:10px 14px; border-radius:999px; border:none; cursor:pointer;
      font-weight:900; letter-spacing:0.10em; text-transform:uppercase;
      font-size:11px; display:inline-flex; gap:8px; align-items:center; justify-content:center;
      text-decoration:none; white-space:nowrap; user-select:none;
      transition: transform .15s ease, filter .15s ease, opacity .15s ease;
    }
    .btn:active{ transform: translateY(1px) scale(0.99); }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; }
    .btn-secondary{ background:rgba(255,255,255,0.07); border:1px solid rgba(148,163,184,0.40); color:var(--text); }
    .btn-secondary:hover{ filter: brightness(1.10); }
    .btn-primary{ background: linear-gradient(135deg, var(--accent), var(--accent2)); color:#fff; }
    .btn-danger{ background: rgba(251,113,133,0.16); border:1px solid rgba(251,113,133,0.30); color:#ffdbe4; }

    .card{
      border:1px solid rgba(148,163,184,0.35);
      border-radius:var(--radius);
      background: linear-gradient(145deg, var(--glass2), var(--glass1));
      backdrop-filter: blur(28px);
      box-shadow: var(--shadow);
      padding:16px;
    }
    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .muted{ color:rgba(148,163,184,0.95); font-size:12px; }
    .input{
      width: min(420px, 100%);
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,0.40);
      background: rgba(0,0,0,0.18);
      color: var(--text);
      outline:none;
      font-weight:700;
    }

    table{ width:100%; border-collapse:separate; border-spacing:0 10px; }
    th{
      text-align:left;
      font-size:11px;
      letter-spacing:0.12em;
      text-transform:uppercase;
      color:rgba(148,163,184,0.95);
      padding:0 10px;
    }
    td{
      padding:12px 10px;
      background: rgba(255,255,255,0.04);
      border-top:1px solid rgba(148,163,184,0.22);
      border-bottom:1px solid rgba(148,163,184,0.22);
    }
    td:first-child{
      border-left:1px solid rgba(148,163,184,0.22);
      border-radius:16px 0 0 16px;
    }
    td:last-child{
      border-right:1px solid rgba(148,163,184,0.22);
      border-radius:0 16px 16px 0;
    }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 11px; border-radius:999px;
      border:1px solid rgba(148,163,184,0.35);
      background: rgba(0,0,0,0.18);
      font-weight:900; font-size:10px; letter-spacing:0.10em; text-transform:uppercase;
      color: rgba(226,232,240,0.92);
      white-space:nowrap;
    }
    .dot{ width:8px; height:8px; border-radius:50%; background:var(--muted); }
    .dot.ok{ background: var(--emerald); box-shadow:0 0 0 4px rgba(34,197,94,0.14); }
    .dot.warn{ background: var(--gold); box-shadow:0 0 0 4px rgba(251,191,36,0.12); }
    .toast{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,0.25);
      background: rgba(0,0,0,0.18);
      display:none;
      white-space:pre-wrap;
      line-height:1.35;
    }
    .toast.show{ display:block; }
  </style>
</head>

<body>
  <div class="page">

    <div class="topbar">
      <div class="brand">
        <img src="https://github.com/qfsnesaragesara/BTC-METAL-CARD-PAYMENT/blob/main/photo%201.jpg?raw=true" alt="QFS Logo">
        <div>
          <div class="t1">Admin Confirm</div>
          <div class="t2">Approve in 1 click (updates portal_users by email)</div>
        </div>
      </div>

      <div class="row">
        <span id="sessionPill" class="pill"><span class="dot warn"></span> Booting…</span>
        <button id="logoutBtn" class="btn btn-secondary" style="display:none;">Logout</button>
        <a class="btn btn-secondary" href="index.html">Home</a>
      </div>
    </div>

    <!-- LOGIN CARD -->
    <div id="loginCard" class="card">
      <div class="row" style="justify-content:space-between;">
        <div>
          <div class="pill"><span class="dot warn"></span> Admin Login</div>
          <div class="muted" style="margin-top:6px;">Only admin emails should sign in here.</div>
        </div>
      </div>

      <div class="row" style="margin-top:12px;">
        <input id="email" class="input" type="email" placeholder="Admin email" autocomplete="email">
        <input id="password" class="input" type="password" placeholder="Password" autocomplete="current-password">
        <button id="loginBtn" class="btn btn-primary" type="button">Sign In</button>
      </div>

      <div id="loginToast" class="toast"></div>
    </div>

    <!-- PENDING LIST -->
    <div id="pendingCard" class="card" style="display:none;">
      <div class="row" style="justify-content:space-between;">
        <div>
          <div class="pill"><span class="dot ok"></span> Pending Submissions</div>
          <div class="muted" style="margin-top:6px;">Approving sets status=confirmed + activates portal_users by email.</div>
        </div>
        <div class="row">
          <button id="refreshBtn" class="btn btn-secondary" type="button">Refresh</button>
        </div>
      </div>

      <div id="pendingToast" class="toast"></div>

      <div style="overflow:auto; margin-top:10px;">
        <table>
          <thead>
            <tr>
              <th>Created</th>
              <th>Email</th>
              <th>Card</th>
              <th>Qty</th>
              <th>Note</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </div>

  </div>

  <script>
    const SUPABASE_URL = "https://qagktukzxtwbjrdgiben.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFhZ2t0dWt6eHR3YmpyZGdpYmVuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4NDA0NTQsImV4cCI6MjA4MzQxNjQ1NH0.cbhSWHGlmhmIt-NmUVBUtAhPpNPDKk4Bz-Gy1TbPzHk";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const loginCard = document.getElementById("loginCard");
    const pendingCard = document.getElementById("pendingCard");
    const sessionPill = document.getElementById("sessionPill");
    const logoutBtn = document.getElementById("logoutBtn");

    const emailEl = document.getElementById("email");
    const passEl = document.getElementById("password");
    const loginBtn = document.getElementById("loginBtn");
    const refreshBtn = document.getElementById("refreshBtn");

    const rowsEl = document.getElementById("rows");
    const loginToast = document.getElementById("loginToast");
    const pendingToast = document.getElementById("pendingToast");

    function showToast(el, msg){
      el.textContent = msg;
      el.classList.add("show");
      clearTimeout(el.__t);
      el.__t = setTimeout(()=> el.classList.remove("show"), 4200);
    }

    function setPill(text, ok){
      sessionPill.innerHTML = `<span class="dot ${ok ? "ok":"warn"}"></span> ${text}`;
    }

    function setSignedInUI(isSignedIn){
      if(isSignedIn){
        loginCard.style.display = "none";
        pendingCard.style.display = "block";
        logoutBtn.style.display = "inline-flex";
      } else {
        loginCard.style.display = "block";
        pendingCard.style.display = "none";
        logoutBtn.style.display = "none";
      }
    }

    function fmtDate(ts){
      try { return new Date(ts).toLocaleString(); } catch { return ts; }
    }

    function normTier(v){
      const s = String(v || "").trim().toLowerCase();
      if (s === "gold" || s === "silver" || s === "black") return s;
      return "";
    }
    function normQty(tier, qty){
      let q = Number(qty || 0);
      if (!Number.isFinite(q) || q < 1) q = 1;
      if (tier === "black") q = 1;
      if (tier === "silver") q = Math.min(50, Math.max(1, q));
      if (tier === "gold") q = Math.max(1, q);
      return q;
    }

    async function requireAdmin(){
      const { data, error } = await supabase.rpc("is_admin");
      if(error) return { ok:false, reason:error.message };
      if(data !== true) return { ok:false, reason:"Not an admin" };
      return { ok:true };
    }

    async function upsertPortalUserByEmail(emailRaw, tierRaw, qtyRaw, makeActive){
      const email = String(emailRaw || "").trim().toLowerCase();
      const tier = normTier(tierRaw) || "silver";
      const qty = normQty(tier, qtyRaw);

      if(!email) return { ok:false, error:"Missing email" };

      const payload = {
        email,
        tier,
        selected_tier: tier,
        qty,
        is_active: makeActive ? true : false,
      };

      const { error } = await supabase
        .from("portal_users")
        .upsert(payload, { onConflict: "email" });

      if(error) return { ok:false, error:error.message };
      return { ok:true, email, tier, qty };
    }

    async function loadPending(){
      rowsEl.innerHTML = `<tr><td colspan="6" class="muted">Loading…</td></tr>`;

      const { data, error } = await supabase
        .from("payment_submissions")
        .select("id,email,card_type,qty,status,created_at,note")
        .eq("status","pending")
        .order("created_at", { ascending:false })
        .limit(50);

      if(error){
        rowsEl.innerHTML = `<tr><td colspan="6" class="muted">Error: ${error.message}</td></tr>`;
        showToast(pendingToast, "Load error: " + error.message);
        return;
      }

      if(!data || data.length === 0){
        rowsEl.innerHTML = `<tr><td colspan="6" class="muted">No pending submissions.</td></tr>`;
        return;
      }

      rowsEl.innerHTML = "";
      data.forEach((r) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="muted">${fmtDate(r.created_at)}</td>
          <td class="mono">${r.email || "—"}</td>
          <td><span class="pill">${String(r.card_type || "—").toUpperCase()}</span></td>
          <td>${Number(r.qty || 1)}</td>
          <td class="muted">${r.note ? String(r.note) : "—"}</td>
          <td>
            <div class="row">
              <button class="btn btn-primary" type="button" data-approve="${r.id}">Approve</button>
              <button class="btn btn-danger" type="button" data-reject="${r.id}">Reject</button>
            </div>
          </td>
        `;
        rowsEl.appendChild(tr);
      });

      rowsEl.querySelectorAll("button[data-approve]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-approve");
          await actOn(id, "confirmed", btn);
        });
      });

      rowsEl.querySelectorAll("button[data-reject]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-reject");
          await actOn(id, "rejected", btn);
        });
      });
    }

    async function actOn(id, status, btn){
      try{
        btn.disabled = true;
        const old = btn.textContent;
        btn.textContent = "Working…";

        const { data: row, error: getErr } = await supabase
          .from("payment_submissions")
          .select("id,email,card_type,qty,status")
          .eq("id", id)
          .maybeSingle();

        if(getErr || !row) throw new Error(getErr?.message || "Submission not found");

        const { error: updErr } = await supabase
          .from("payment_submissions")
          .update({ status })
          .eq("id", id)
          .eq("status","pending");

        if(updErr) throw new Error(updErr.message);

        if(status === "confirmed"){
          const tier = normTier(row.card_type) || "silver";
          const qty = normQty(tier, row.qty);
          const up = await upsertPortalUserByEmail(row.email, tier, qty, true);
          if(!up.ok) throw new Error("portal_users update failed: " + up.error);

          showToast(pendingToast, `Approved ✅ ${up.email} → ${up.tier.toUpperCase()} x${up.qty} (active)`);
        } else {
          showToast(pendingToast, `Rejected ✅ ${String(row.email || "").toLowerCase()}`);
        }

        await loadPending();
        btn.textContent = old;
        btn.disabled = false;
      } catch(e){
        btn.disabled = false;
        btn.textContent = (status === "confirmed") ? "Approve" : "Reject";
        showToast(pendingToast, "Error: " + (e?.message || e));
      }
    }

    loginBtn.addEventListener("click", async () => {
      try{
        const email = (emailEl.value || "").trim();
        const password = passEl.value || "";

        if(!email || !password){
          showToast(loginToast, "Enter email + password.");
          return;
        }

        loginBtn.disabled = true;
        showToast(loginToast, "Signing in…");

        const { data, error } = await supabase.auth.signInWithPassword({ email, password });

        loginBtn.disabled = false;

        if(error){
          showToast(loginToast, "Login failed: " + error.message);
          return;
        }

        const admin = await requireAdmin();
        if(!admin.ok){
          showToast(loginToast, "Not authorized: " + (admin.reason || "Not admin"));
          await supabase.auth.signOut();
          return;
        }

        setPill("Signed in", true);
        setSignedInUI(true);
        showToast(loginToast, "Signed in ✅");
        await loadPending();
      } catch(e){
        loginBtn.disabled = false;
        showToast(loginToast, "JS error: " + (e?.message || e));
      }
    });

    logoutBtn.addEventListener("click", async () => {
      try{ await supabase.auth.signOut(); } catch {}
      setPill("Not signed in", false);
      setSignedInUI(false);
      showToast(loginToast, "Signed out ✅");
    });

    refreshBtn.addEventListener("click", loadPending);

    (async function boot(){
      try{
        const { data } = await supabase.auth.getSession();
        const hasSession = !!data?.session;

        if(!hasSession){
          setSignedInUI(false);
          setPill("Not signed in", false);
          showToast(loginToast, "Ready ✅ Enter admin email + password.");
          return;
        }

        const admin = await requireAdmin();
        if(!admin.ok){
          await supabase.auth.signOut();
          setSignedInUI(false);
          setPill("Access denied", false);
          showToast(loginToast, "Not authorized: " + (admin.reason || "Not admin"));
          return;
        }

        setSignedInUI(true);
        setPill("Signed in", true);
        await loadPending();
      } catch(e){
        setPill("Boot error", false);
        showToast(loginToast, "Boot error: " + (e?.message || e));
      }
    })();
  </script>
</body>
</html>
