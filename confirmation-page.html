<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/png" href="https://github.com/qfsnesaragesara/BTC-METAL-CARD-PAYMENT/blob/main/photo%201.jpg?raw=true">
<title>Order Confirmation — QFS Metal Card</title>

<!-- Supabase JS (v2) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  :root {
    --bg:#020617;
    --glass-bg:rgba(255,255,255,0.07);
    --glass-border:rgba(255,255,255,0.18);
    --text:#e2e8f0;
    --muted:#94a3b8;
    --accent:#38bdf8;
    --accent2:#a855f7;
  }

  body {
    margin: 0;
    padding: 0;
    font-family: Inter, -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui;
    background: radial-gradient(circle at top, rgba(56,189,248,0.35), transparent 55%),
                radial-gradient(circle at bottom, rgba(147,51,234,0.35), transparent 60%),
                var(--bg);
    color: var(--text);
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    padding: 22px 0;
  }

  .container {
    width: 90%;
    max-width: 520px;
    padding: 40px 34px;
    background: var(--glass-bg);
    border-radius: 28px;
    border: 1px solid var(--glass-border);
    backdrop-filter: blur(28px);
    text-align:center;
  }

  .logo {
    width: 160px;
    display: block;
    margin: 0 auto 18px auto;
    filter: drop-shadow(0 8px 14px rgba(56,189,248,0.25));
  }

  h1 {
    font-size: 32px;
    margin-bottom: 8px;
    font-weight: 800;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  p {
    color: var(--muted);
    font-size: 15px;
    line-height: 1.55;
    margin: 0 0 12px;
  }

  label{
    display:block;
    text-align:left;
    margin-top: 14px;
    margin-bottom: 6px;
    font-weight: 700;
    color: rgba(226,232,240,0.95);
    font-size: 14px;
  }

  input[type="text"],
  input[type="email"] {
    width: 100%;
    padding: 14px;
    margin-top: 4px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,0.18);
    background: rgba(255,255,255,0.06);
    color: var(--text);
    font-size: 16px;
    outline: none;
  }

  .file-wrap{
    width:100%;
    padding: 14px;
    border-radius: 14px;
    border: 1px dashed rgba(255,255,255,0.22);
    background: rgba(255,255,255,0.05);
    text-align:left;
  }
  input[type="file"]{
    width:100%;
    color: var(--text);
  }
  .hint{
    margin-top:8px;
    font-size: 12px;
    color: rgba(148,163,184,0.95);
    line-height:1.4;
  }
  .preview{
    margin-top:12px;
    display:none;
    border-radius: 14px;
    overflow:hidden;
    border:1px solid rgba(255,255,255,0.14);
    background: rgba(0,0,0,0.18);
  }
  .preview img{
    width:100%;
    display:block;
    max-height: 240px;
    object-fit: cover;
  }

  .btn {
    width: 100%;
    margin-top: 18px;
    padding: 15px;
    font-size: 18px;
    font-weight: 800;
    border-radius: 14px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    color: #fff;
    border: none;
    cursor: pointer;
  }
  .btn:disabled{
    opacity: .6;
    cursor: not-allowed;
  }

  .status {
    margin-top: 14px;
    font-size: 13px;
    color: rgba(226,232,240,0.9);
    line-height: 1.4;
    text-align:left;
    background: rgba(0,0,0,0.18);
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 14px;
    padding: 12px 12px;
    display:none;
  }
</style>
</head>

<body>
<div class="container">

  <img class="logo"
       src="https://github.com/qfsnesaragesara/BTC-METAL-CARD-PAYMENT/blob/main/photo%201.jpg?raw=true"
       alt="Brand Logo">

  <h1>Payment Confirmation</h1>
  <p>Submit your <b>TXID</b>, <b>Email</b>, and a <b>payment screenshot</b>. Your request will show as <b>Pending</b> until admin approval.</p>

  <form id="confirmForm">
    <input type="hidden" id="orderIdField">
    <input type="hidden" id="cardTypeField">
    <input type="hidden" id="qtyField">
    <input type="hidden" id="usdField">
    <input type="hidden" id="btcField">
    <input type="hidden" id="addrField">

    <label>Transaction Hash (TXID)</label>
    <input id="txid" type="text" placeholder="Enter your TXID" required>

    <label>Email Address</label>
    <input id="email" type="email" placeholder="Enter your email" required>

    <label>Payment Screenshot</label>
    <div class="file-wrap">
      <input id="payShot" type="file" accept="image/*" required>
      <div class="hint">Upload a clear screenshot showing transaction details (image only).</div>

      <div class="preview" id="previewBox">
        <img id="previewImg" alt="Screenshot preview">
      </div>
    </div>

    <button id="submitBtn" type="submit" class="btn">Submit Confirmation</button>
    <div id="statusBox" class="status"></div>
  </form>

</div>

<script>
/* =========================
   1) SUPABASE
   ========================= */
const SUPABASE_URL = "https://qagktukzxtwbjrdgiben.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFhZ2t0dWt6eHR3YmpyZGdpYmVuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4NDA0NTQsImV4cCI6MjA4MzQxNjQ1NH0.cbhSWHGlmhmIt-NmUVBUtAhPpNPDKk4Bz-Gy1TbPzHk";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* =========================
   Helpers
   ========================= */
function safeLower(s){ return (s || "").trim().toLowerCase(); }
function qs(key){ return new URLSearchParams(location.search).get(key); }

function setStatus(msg){
  const box = document.getElementById("statusBox");
  box.style.display = "block";
  box.textContent = msg;
}

function normTier(v) {
  const s = safeLower(v);
  if (s === "gold" || s === "silver" || s === "black") return s;
  return "";
}

// Your rule (grouped)
function routeByTierLikeYouWant(tierValue) {
  const t = normTier(tierValue);
  if (t === "gold") return "portal-gold.html";
  return "portal.html"; // silver + black + fallback
}

function inferTierFromCardType(typeValue) {
  const t = safeLower(typeValue);
  if (t.includes("gold")) return "gold";
  if (t.includes("black")) return "black";
  if (t.includes("silver")) return "silver";
  return "";
}

/* =========================
   Prefill hidden context from URL (from wallet.html)
   ========================= */
(function(){
  const params = new URLSearchParams(window.location.search);

  const type = safeLower(params.get("type"));
  const qtyRaw = params.get("qty") || "";
  const usd = params.get("usd") || "";
  const btc = params.get("btc") || "";
  const addr = params.get("addr") || "";

  const fromUrl = params.get("order");
  const fromLocal = localStorage.getItem("qfsOrderId");
  const orderId = fromUrl || fromLocal || "";

  document.getElementById("orderIdField").value = orderId;
  document.getElementById("cardTypeField").value = type;
  document.getElementById("qtyField").value = qtyRaw;
  document.getElementById("usdField").value = usd;
  document.getElementById("btcField").value = btc;
  document.getElementById("addrField").value = addr;
})();

/* =========================
   Screenshot preview
   ========================= */
(function(){
  const input = document.getElementById("payShot");
  const previewBox = document.getElementById("previewBox");
  const previewImg = document.getElementById("previewImg");

  input.addEventListener("change", () => {
    const file = input.files && input.files[0];
    if(!file){
      previewBox.style.display = "none";
      previewImg.src = "";
      return;
    }
    if(!file.type.startsWith("image/")){
      alert("Please upload an image file only.");
      input.value = "";
      previewBox.style.display = "none";
      previewImg.src = "";
      return;
    }
    const url = URL.createObjectURL(file);
    previewImg.src = url;
    previewBox.style.display = "block";
  });
})();

/* =========================
   Require login (so we have auth.uid + stable routing)
   ========================= */
let CURRENT_USER = null;

(async function requireLogin(){
  try{
    const { data, error } = await supabase.auth.getUser();
    if (error || !data?.user) {
      // remember where to come back
      const next = encodeURIComponent(window.location.pathname + window.location.search);
      window.location.href = "login.html?next=" + next;
      return;
    }
    CURRENT_USER = data.user;

    // Prefill email with account email (safer)
    const emailEl = document.getElementById("email");
    if (emailEl && !emailEl.value) emailEl.value = (CURRENT_USER.email || "");

  }catch{
    const next = encodeURIComponent(window.location.pathname + window.location.search);
    window.location.href = "login.html?next=" + next;
  }
})();

/* =========================
   Submit -> Upload screenshot -> Insert row -> Sync portal_users -> Redirect
   ========================= */
document.getElementById("confirmForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const btn = document.getElementById("submitBtn");
  btn.disabled = true;

  try {
    // ensure login check completed
    if (!CURRENT_USER) {
      btn.disabled = false;
      setStatus("Please login first. Redirecting…");
      const next = encodeURIComponent(window.location.pathname + window.location.search);
      window.location.href = "login.html?next=" + next;
      return;
    }

    const txid = document.getElementById("txid").value.trim();
    const typedEmail = safeLower(document.getElementById("email").value);
    const fileInput = document.getElementById("payShot");
    const file = fileInput.files && fileInput.files[0];

    if(!txid || !typedEmail || !file){
      btn.disabled = false;
      return;
    }

    // Determine tier from URL card type, or localStorage fallback
    const cardType = document.getElementById("cardTypeField").value || "";
    const tierFromType = inferTierFromCardType(cardType);
    const tierFromLocal = normTier(localStorage.getItem("qfs_selected_tier"));
    const effectiveTier = tierFromType || tierFromLocal || "silver"; // safe default

    // Save locally (keeps pages consistent even before activation)
    try { localStorage.setItem("qfs_selected_tier", effectiveTier); } catch {}

    setStatus("Uploading screenshot…");

    const ext = (file.name.split(".").pop() || "jpg").toLowerCase().replace(/[^a-z0-9]/g,"");
    const safeExt = ext || "jpg";
    const objectPath = `confirmations/${crypto.randomUUID()}.${safeExt}`;

    // Upload to private bucket
    const { error: upErr } = await supabase
      .storage
      .from("payment-screenshots")
      .upload(objectPath, file, { upsert: false, contentType: file.type });

    if(upErr) throw upErr;

    setStatus("Submitting confirmation…");

    const payload = {
      card_type: cardType || null,
      qty: document.getElementById("qtyField").value ? Number(document.getElementById("qtyField").value) : null,
      usd: document.getElementById("usdField").value || null,
      btc: document.getElementById("btcField").value || null,
      wallet_addr: document.getElementById("addrField").value || null,
      order_id: document.getElementById("orderIdField").value || null,
      txid,
      email: typedEmail,
      screenshot_path: objectPath,
      // if your table has user_id, keep it (harmless if column doesn't exist? actually insert would fail)
      // so we do NOT include user_id unless you confirm the column exists.
    };

    const { error: insErr } = await supabase
      .from("payment_confirmations")
      .insert(payload);

    if(insErr) throw insErr;

    // ✅ Sync portal_users (tier NOT NULL in your schema)
    // We keep is_active=false until admin confirms.
    try{
      const upsertRow = {
        id: CURRENT_USER.id,
        email: (CURRENT_USER.email || typedEmail || null),
        selected_tier: effectiveTier,
        tier: effectiveTier,
        is_active: false,
        qty: 0
      };

      const { error: puErr } = await supabase
        .from("portal_users")
        .upsert(upsertRow, { onConflict: "id" });

      if (puErr) {
        console.warn("portal_users upsert warning:", puErr.message);
      }
    }catch(err){
      console.warn("portal_users upsert exception:", err);
    }

    setStatus("Submitted ✅ Your confirmation is now pending admin review… Redirecting…");

    // ✅ Your rule: gold -> portal-gold.html, silver+black -> portal.html
    setTimeout(() => {
      window.location.href = routeByTierLikeYouWant(effectiveTier);
    }, 900);

  } catch (err) {
    console.error(err);
    const m = (err && err.message) ? err.message : "Submission failed.";
    setStatus("Error: " + m);
    btn.disabled = false;
  }
});
</script>

</body>
</html>
