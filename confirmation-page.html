<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/png" href="https://github.com/qfsnesaragesara/BTC-METAL-CARD-PAYMENT/blob/main/photo%201.jpg?raw=true">
<title>Order Confirmation — QFS Metal Card</title>

<!-- Supabase JS (v2) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  :root {
    --bg:#020617;
    --glass-bg:rgba(255,255,255,0.07);
    --glass-border:rgba(255,255,255,0.18);
    --text:#e2e8f0;
    --muted:#94a3b8;
    --accent:#38bdf8;
    --accent2:#a855f7;
  }

  body {
    margin: 0;
    padding: 0;
    font-family: Inter, -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui;
    background: radial-gradient(circle at top, rgba(56,189,248,0.35), transparent 55%),
                radial-gradient(circle at bottom, rgba(147,51,234,0.35), transparent 60%),
                var(--bg);
    color: var(--text);
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    padding: 22px 0;
  }

  .container {
    width: 90%;
    max-width: 520px;
    padding: 40px 34px;
    background: var(--glass-bg);
    border-radius: 28px;
    border: 1px solid var(--glass-border);
    backdrop-filter: blur(28px);
    text-align:center;
  }

  .logo {
    width: 160px;
    display: block;
    margin: 0 auto 18px auto;
    filter: drop-shadow(0 8px 14px rgba(56,189,248,0.25));
  }

  h1 {
    font-size: 32px;
    margin-bottom: 8px;
    font-weight: 800;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  p {
    color: var(--muted);
    font-size: 15px;
    line-height: 1.55;
    margin: 0 0 12px;
  }

  label{
    display:block;
    text-align:left;
    margin-top: 14px;
    margin-bottom: 6px;
    font-weight: 700;
    color: rgba(226,232,240,0.95);
    font-size: 14px;
  }

  input[type="text"],
  input[type="email"] {
    width: 100%;
    padding: 14px;
    margin-top: 4px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,0.18);
    background: rgba(255,255,255,0.06);
    color: var(--text);
    font-size: 16px;
    outline: none;
  }

  .file-wrap{
    width:100%;
    padding: 14px;
    border-radius: 14px;
    border: 1px dashed rgba(255,255,255,0.22);
    background: rgba(255,255,255,0.05);
    text-align:left;
  }
  input[type="file"]{
    width:100%;
    color: var(--text);
  }
  .hint{
    margin-top:8px;
    font-size: 12px;
    color: rgba(148,163,184,0.95);
    line-height:1.4;
  }
  .preview{
    margin-top:12px;
    display:none;
    border-radius: 14px;
    overflow:hidden;
    border:1px solid rgba(255,255,255,0.14);
    background: rgba(0,0,0,0.18);
  }
  .preview img{
    width:100%;
    display:block;
    max-height: 240px;
    object-fit: cover;
  }

  .btn {
    width: 100%;
    margin-top: 18px;
    padding: 15px;
    font-size: 18px;
    font-weight: 800;
    border-radius: 14px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    color: #fff;
    border: none;
    cursor: pointer;
  }
  .btn:disabled{
    opacity: .6;
    cursor: not-allowed;
  }

  .status {
    margin-top: 14px;
    font-size: 13px;
    color: rgba(226,232,240,0.9);
    line-height: 1.4;
    text-align:left;
    background: rgba(0,0,0,0.18);
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 14px;
    padding: 12px 12px;
    display:none;
  }
</style>
</head>

<body>
<div class="container">

  <img class="logo"
       src="https://github.com/qfsnesaragesara/BTC-METAL-CARD-PAYMENT/blob/main/photo%201.jpg?raw=true"
       alt="Brand Logo">

  <h1>Payment Confirmation</h1>
  <p>Submit your <b>TXID</b>, <b>Email</b>, and a <b>payment screenshot</b>. Your request will show as <b>Pending</b> until admin approval.</p>

  <form id="confirmForm">
    <input type="hidden" id="orderIdField">
    <input type="hidden" id="cardTypeField">
    <input type="hidden" id="qtyField">
    <input type="hidden" id="usdField">
    <input type="hidden" id="btcField">
    <input type="hidden" id="addrField">

    <label>Transaction Hash (TXID)</label>
    <input id="txid" type="text" placeholder="Enter your TXID" required>

    <label>Email Address</label>
    <input id="email" type="email" placeholder="Enter your email" required>

    <label>Payment Screenshot</label>
    <div class="file-wrap">
      <input id="payShot" type="file" accept="image/*" required>
      <div class="hint">Upload a clear screenshot showing transaction details (image only).</div>

      <div class="preview" id="previewBox">
        <img id="previewImg" alt="Screenshot preview">
      </div>
    </div>

    <button id="submitBtn" type="submit" class="btn">Submit Confirmation</button>
    <div id="statusBox" class="status"></div>
  </form>

</div>

<script>
/* =========================
   1) PUT YOUR SUPABASE KEYS HERE
   ========================= */
const SUPABASE_URL = "PASTE_YOUR_SUPABASE_URL_HERE";
const SUPABASE_ANON_KEY = "PASTE_YOUR_SUPABASE_ANON_KEY_HERE";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* =========================
   Helpers
   ========================= */
function qs(key){ return new URLSearchParams(location.search).get(key); }

function setStatus(msg){
  const box = document.getElementById("statusBox");
  box.style.display = "block";
  box.textContent = msg;
}

function safeLower(s){ return (s || "").trim().toLowerCase(); }

/* =========================
   Prefill hidden context from URL (from wallet.html)
   ========================= */
(function(){
  const params = new URLSearchParams(window.location.search);

  const type = safeLower(params.get("type"));
  const qtyRaw = params.get("qty") || "";
  const usd = params.get("usd") || "";
  const btc = params.get("btc") || "";
  const addr = params.get("addr") || "";

  const fromUrl = params.get("order");
  const fromLocal = localStorage.getItem("qfsOrderId");
  const orderId = fromUrl || fromLocal || "";

  document.getElementById("orderIdField").value = orderId;
  document.getElementById("cardTypeField").value = type;
  document.getElementById("qtyField").value = qtyRaw;
  document.getElementById("usdField").value = usd;
  document.getElementById("btcField").value = btc;
  document.getElementById("addrField").value = addr;
})();

/* =========================
   Screenshot preview
   ========================= */
(function(){
  const input = document.getElementById("payShot");
  const previewBox = document.getElementById("previewBox");
  const previewImg = document.getElementById("previewImg");

  input.addEventListener("change", () => {
    const file = input.files && input.files[0];
    if(!file){
      previewBox.style.display = "none";
      previewImg.src = "";
      return;
    }
    if(!file.type.startsWith("image/")){
      alert("Please upload an image file only.");
      input.value = "";
      previewBox.style.display = "none";
      previewImg.src = "";
      return;
    }
    const url = URL.createObjectURL(file);
    previewImg.src = url;
    previewBox.style.display = "block";
  });
})();

/* =========================
   Submit -> Upload screenshot -> Insert row -> Redirect
   ========================= */
document.getElementById("confirmForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const btn = document.getElementById("submitBtn");
  btn.disabled = true;

  try {
    const txid = document.getElementById("txid").value.trim();
    const email = document.getElementById("email").value.trim().toLowerCase();
    const fileInput = document.getElementById("payShot");
    const file = fileInput.files && fileInput.files[0];

    if(!txid || !email || !file){
      btn.disabled = false;
      return;
    }

    setStatus("Uploading screenshot…");

    const ext = (file.name.split(".").pop() || "jpg").toLowerCase().replace(/[^a-z0-9]/g,"");
    const safeExt = ext || "jpg";
    const objectPath = `confirmations/${crypto.randomUUID()}.${safeExt}`;

    // Upload to private bucket
    const { error: upErr } = await supabase
      .storage
      .from("payment-screenshots")
      .upload(objectPath, file, { upsert: false, contentType: file.type });

    if(upErr) throw upErr;

    setStatus("Submitting confirmation…");

    const payload = {
      card_type: document.getElementById("cardTypeField").value || null,
      qty: document.getElementById("qtyField").value ? Number(document.getElementById("qtyField").value) : null,
      usd: document.getElementById("usdField").value || null,
      btc: document.getElementById("btcField").value || null,
      wallet_addr: document.getElementById("addrField").value || null,
      order_id: document.getElementById("orderIdField").value || null,
      txid,
      email,
      screenshot_path: objectPath
    };

    const { error: insErr } = await supabase
      .from("payment_confirmations")
      .insert(payload);

    if(insErr) throw insErr;

    setStatus("Submitted ✅ Your confirmation is now pending admin review… Redirecting…");

    const tier = (payload.card_type || "unknown");
    const redirectParams = new URLSearchParams({
      tier,
      status: "pending"
    });

    setTimeout(() => {
      window.location.href = "order-success.html?" + redirectParams.toString();
    }, 900);

  } catch (err) {
    console.error(err);
    const msg = (err && err.message) ? err.message : "Submission failed.";
    setStatus("Error: " + msg);
    btn.disabled = false;
  }
});
</script>

</body>
</html>
