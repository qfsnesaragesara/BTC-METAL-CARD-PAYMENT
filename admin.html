<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Console</title>
  <style>
    :root{
      --bg:#071524;
      --panel:#0b2034;
      --panel2:#0a1b2d;
      --text:#e9f2ff;
      --muted:#a7bdd8;
      --accent:#7aa8ff;
      --danger:#ff6b6b;
      --ok:#40d39c;
      --warn:#ffcc66;
      --border:rgba(255,255,255,.10);
      --shadow: 0 18px 70px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 600px at 30% 10%, rgba(122,168,255,.12), transparent 60%),
                  radial-gradient(900px 500px at 90% 30%, rgba(64,211,156,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    header{
      padding:18px 22px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.04), transparent);
    }
    header .title{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    header h1{margin:0;font-size:18px;letter-spacing:.3px}
    header .sub{color:var(--muted);font-size:12px}
    header .right{
      display:flex; gap:10px; align-items:center;
    }
    button{
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:8px 12px;
      border-radius: 999px;
      cursor:pointer;
      transition: transform .06s ease, background .12s ease;
    }
    button:hover{background: rgba(255,255,255,.09)}
    button:active{transform: translateY(1px)}
    button.primary{
      border-color: rgba(122,168,255,.35);
      background: rgba(122,168,255,.16);
    }
    button.danger{
      border-color: rgba(255,107,107,.35);
      background: rgba(255,107,107,.14);
    }
    button[disabled]{
      opacity:.55;
      cursor:not-allowed;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      font-size:12px;
      color:var(--muted);
    }
    .dot{width:8px;height:8px;border-radius:999px;background:var(--warn)}
    .dot.ok{background:var(--ok)}
    .dot.bad{background:var(--danger)}
    .wrap{
      padding:18px 18px 28px;
      max-width:1200px;
      margin:0 auto;
    }
    .banner{
      border:1px solid rgba(255,107,107,.35);
      background: rgba(255,107,107,.10);
      color:#ffd4d4;
      padding:10px 12px;
      border-radius: 12px;
      margin-bottom:14px;
      display:none;
      white-space: pre-wrap;
    }
    .grid{
      display:grid;
      grid-template-columns: 1.1fr 1fr;
      gap:14px;
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
      min-height: 120px;
    }
    .card h2{
      margin:0 0 10px;
      font-size:14px;
      color:#d9e8ff;
      letter-spacing:.2px;
    }
    .row{display:flex;gap:10px;align-items:center}
    input, select, textarea{
      width:100%;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
    }
    input[disabled], select[disabled], textarea[disabled]{
      opacity:.6;
      cursor:not-allowed;
    }
    textarea{min-height:72px;resize:vertical}
    .muted{color:var(--muted);font-size:12px}
    .members{
      margin-top:10px;
      border-top:1px solid var(--border);
      padding-top:10px;
      max-height: 420px;
      overflow:auto;
    }
    .member{
      display:grid;
      grid-template-columns: 1fr 1fr 110px;
      gap:10px;
      padding:10px;
      border:1px solid var(--border);
      border-radius: 14px;
      background: rgba(255,255,255,.03);
      margin-bottom:8px;
      align-items:center;
    }
    .member .id{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;font-size:11px;color:var(--muted)}
    .member .email{font-size:13px}
    .member button{justify-self:end}
    .kv{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin:10px 0 14px;
    }
    .box{
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px 12px;
      background: rgba(255,255,255,.03);
    }
    .box .label{color:var(--muted);font-size:12px;margin-bottom:6px}
    .box .value{font-size:20px;font-weight:650}
    .toggleRow{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-top:8px}
    .switch{
      position:relative; width:52px; height:28px;
      background: rgba(255,255,255,.10);
      border:1px solid var(--border);
      border-radius:999px;
      cursor:pointer;
      flex: 0 0 auto;
    }
    .knob{
      position:absolute; top:3px; left:3px;
      width:22px; height:22px; border-radius:999px;
      background: rgba(255,255,255,.85);
      transition:left .14s ease;
    }
    .switch.on{background: rgba(64,211,156,.16); border-color: rgba(64,211,156,.30)}
    .switch.on .knob{left:27px}
    .switch[aria-disabled="true"]{
      opacity:.6;
      cursor:not-allowed;
    }
    table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      font-size:12px;
    }
    th, td{
      border-bottom:1px solid var(--border);
      padding:8px 6px;
      text-align:left;
      color:#d7e7ff;
    }
    th{color:var(--muted);font-weight:600}
    .rightAlign{text-align:right}
    .smallMono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace}
    .footerNote{margin-top:10px;color:var(--muted);font-size:12px}
  </style>
</head>

<body>
  <header>
    <div class="title">
      <h1>Admin Console</h1>
      <div class="sub">Credit/Debit USD + BTC (sats) • View balances • View ledger • Toggle activation</div>
    </div>
    <div class="right">
      <div class="pill" id="authPill"><span class="dot" id="authDot"></span><span id="authText">Checking session…</span></div>
      <button id="refreshBtn">Refresh</button>
      <button class="danger" id="logoutBtn">Logout</button>
    </div>
  </header>

  <div class="wrap">
    <div class="banner" id="banner"></div>

    <div class="grid" id="adminGrid">
      <!-- LEFT: Members -->
      <div class="card">
        <h2>Members</h2>
        <div class="row">
          <input id="searchInput" placeholder="Search by email or user_id (UUID)..." />
          <select id="filterSelect" style="max-width:170px">
            <option value="all">All</option>
            <option value="active">Activated</option>
            <option value="pending">Pending</option>
          </select>
          <button class="primary" id="loadMembersBtn" style="max-width:120px">Load</button>
        </div>

        <div class="members" id="membersList"></div>

        <div class="footerNote smallMono" id="adminSessionNote"></div>
      </div>

      <!-- RIGHT: Selected Member -->
      <div class="card">
        <h2>Selected Member</h2>
        <input id="selectedUserId" placeholder="Pick a member on the left, or paste a UUID here…" />
        <div class="row" style="margin-top:10px">
          <button class="primary" id="loadSelectedBtn" style="max-width:120px">Load</button>
          <button id="debugWhoBtn" style="max-width:160px">Who am I?</button>
        </div>

        <div class="kv">
          <div class="box">
            <div class="label">USD Balance</div>
            <div class="value" id="usdBalance">$0.00</div>
            <div class="muted">stored as cents</div>
          </div>
          <div class="box">
            <div class="label">BTC Balance</div>
            <div class="value" id="btcBalance">0 sats</div>
            <div class="muted">stored as sats</div>
          </div>
        </div>

        <div class="box">
          <div class="label">Activation</div>
          <div class="toggleRow">
            <div>
              <div id="activationText" style="font-weight:650">—</div>
              <div class="muted" id="activationSub">—</div>
            </div>
            <div class="switch" id="activationSwitch" role="switch" aria-checked="false">
              <div class="knob"></div>
            </div>
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <select id="currencySelect" style="max-width:120px">
            <option value="USD">USD</option>
            <option value="BTC">BTC</option>
          </select>
          <input id="amountInput" placeholder="Amount (USD in dollars, BTC in sats)" />
        </div>

        <div class="row" style="margin-top:10px">
          <select id="entryTypeSelect" style="max-width:160px">
            <option value="credit">Credit</option>
            <option value="debit">Debit</option>
          </select>
          <input id="reasonInput" placeholder="Reason (e.g. welcome_credit, manual_adjust)" />
        </div>

        <textarea id="metadataInput" placeholder='Optional note/metadata (saved). Example:
{"note":"manual top up"}' style="margin-top:10px"></textarea>

        <div class="row" style="margin-top:10px; justify-content:flex-end">
          <button class="primary" id="submitTxnBtn" style="max-width:160px">Submit</button>
        </div>

        <div class="row" style="margin-top:10px; justify-content:space-between; align-items:flex-end">
          <div>
            <div style="font-weight:650;margin-top:8px">Recent Ledger</div>
            <div class="muted">Last 25 entries (selected member)</div>
          </div>
          <button id="refreshLedgerBtn" style="max-width:140px">Refresh</button>
        </div>

        <table>
          <thead>
            <tr>
              <th>Time</th>
              <th>Cur</th>
              <th>Type</th>
              <th class="rightAlign">Amount</th>
              <th>Reason/Note</th>
            </tr>
          </thead>
          <tbody id="ledgerBody">
            <tr><td colspan="5" class="muted">No member selected.</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Supabase JS (v2) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.90.1/dist/umd/supabase.js"></script>

  <script>
    /******************************************************************
     * HARD GATE:
     * - Keep page hidden until admin is verified.
     * - If no session -> redirect to admin-confirm.html (your login page).
     * - If session but not admin -> lock UI and show 403 banner.
     ******************************************************************/
    document.documentElement.style.visibility = "hidden";

    /******************************************************************
     * CONFIG
     ******************************************************************/
    const SUPABASE_URL = "https://qagktukzxtwbjrdgiben.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFhZ2t0dWt6eHR3YmpyZGdpYmVuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4NDA0NTQsImV4cCI6MjA4MzQxNjQ1NH0.cbhSWHGlmhmIt-NmUVBUtAhPpNPDKk4Bz-Gy1TbPzHk";

    const LOGIN_PAGE = "/admin-confirm.html";

    /******************************************************************
     * CLIENT
     ******************************************************************/
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: false
      }
    });

    /******************************************************************
     * UI HELPERS
     ******************************************************************/
    const $ = (id) => document.getElementById(id);

    function showBanner(msg) {
      const b = $("banner");
      b.textContent = msg;
      b.style.display = msg ? "block" : "none";
    }

    function setAuthPill(ok, text) {
      $("authText").textContent = text;
      $("authDot").classList.remove("ok", "bad");
      $("authDot").classList.add(ok ? "ok" : "bad");
      $("authPill").style.borderColor = ok ? "rgba(64,211,156,.30)" : "rgba(255,107,107,.35)";
    }

    function fmtUsdFromCents(cents) {
      const n = Number(cents || 0) / 100;
      return n.toLocaleString(undefined, { style: "currency", currency: "USD" });
    }

    function fmtBtcSats(sats) {
      return `${Number(sats || 0).toLocaleString()} sats`;
    }

    function safeJsonParse(txt) {
      try { return txt ? JSON.parse(txt) : {}; }
      catch { return null; }
    }

    function setSwitch(isOn) {
      const sw = $("activationSwitch");
      sw.classList.toggle("on", !!isOn);
      sw.setAttribute("aria-checked", !!isOn ? "true" : "false");
    }

    function setSwitchDisabled(disabled) {
      const sw = $("activationSwitch");
      sw.setAttribute("aria-disabled", disabled ? "true" : "false");
      if (disabled) {
        sw.classList.remove("on");
        sw.setAttribute("aria-checked", "false");
      }
    }

    function lockAdminUI() {
      // disable buttons / inputs so nothing can be used
      const idsToDisable = [
        "refreshBtn",
        "loadMembersBtn",
        "loadSelectedBtn",
        "debugWhoBtn",
        "refreshLedgerBtn",
        "submitTxnBtn",
        "searchInput",
        "filterSelect",
        "selectedUserId",
        "currencySelect",
        "amountInput",
        "entryTypeSelect",
        "reasonInput",
        "metadataInput"
      ];
      for (const id of idsToDisable) {
        const el = $(id);
        if (!el) continue;
        if (el.tagName === "INPUT" || el.tagName === "SELECT" || el.tagName === "TEXTAREA" || el.tagName === "BUTTON") {
          el.disabled = true;
        }
      }

      // prevent activation toggle
      setSwitchDisabled(true);

      // keep header visible (layout), but hide grid content to reduce exposure
      const grid = $("adminGrid");
      if (grid) grid.style.display = "none";
    }

    function redirectToLogin() {
      const next = encodeURIComponent(window.location.pathname + window.location.search + window.location.hash);
      window.location.href = `${LOGIN_PAGE}?next=${next}`;
    }

    /******************************************************************
     * AUTH CHECK (IMPORTANT PART)
     ******************************************************************/
    async function requireSessionAndAdmin({ redirectIfNoSession = true } = {}) {
      showBanner("");

      // Session
      let { data: s1, error: e1 } = await supabaseClient.auth.getSession();
      if (e1) console.warn("getSession error:", e1);

      // If session missing, try refresh once
      if (!s1?.session) {
        try {
          const { data: s2 } = await supabaseClient.auth.refreshSession();
          s1 = s2;
        } catch (e) {
          // ignore
        }
      }

      const session = s1?.session || null;
      if (!session) {
        setAuthPill(false, "Not logged in");
        $("adminSessionNote").textContent = "No Supabase session found.";
        if (redirectIfNoSession) {
          redirectToLogin();
        } else {
          document.documentElement.style.visibility = "visible";
        }
        return { ok: false, session: null, isAdmin: false };
      }

      // Admin check via DB (RPC)
      const { data: isAdmin, error: isAdminErr } = await supabaseClient.rpc("is_admin", {});
      if (isAdminErr) {
        console.warn("is_admin rpc error:", isAdminErr);
        setAuthPill(false, "Session OK • Admin check failed");
        $("adminSessionNote").textContent = "Session exists, but admin verification failed.";
        showBanner(`Admin check failed:\n${isAdminErr.message || JSON.stringify(isAdminErr)}`);
        lockAdminUI();
        document.documentElement.style.visibility = "visible";
        return { ok: false, session, isAdmin: false };
      }

      const uid = session.user?.id;
      const email = session.user?.email;

      $("adminSessionNote").textContent = `admin session: ${email || "(no email)"} • uid: ${uid || "(no uid)"}`;

      if (isAdmin === true) {
        setAuthPill(true, "Logged in • Admin: YES");
        // show page only after success
        document.documentElement.style.visibility = "visible";
        return { ok: true, session, isAdmin: true };
      }

      // Not admin: lock and show 403
      setAuthPill(false, "Logged in • Admin: NO");
      showBanner("403 — Admin access only.\nYou are logged in, but your user is not in admin_users (is_admin() returned false).");
      lockAdminUI();
      document.documentElement.style.visibility = "visible";
      return { ok: false, session, isAdmin: false };
    }

    /******************************************************************
     * MEMBERS
     ******************************************************************/
    async function loadMembers() {
      const authState = await requireSessionAndAdmin({ redirectIfNoSession: true });
      if (!authState.session) return;
      if (!authState.isAdmin) return;

      const q = $("searchInput").value.trim();
      const filter = $("filterSelect").value;

      const { data, error } = await supabaseClient.rpc("admin_list_members", {
        p_search: q || null,
        p_filter: filter || "all",
        p_offset: 0
      });

      if (error) {
        showBanner(`Load members failed:\n${error.message || JSON.stringify(error)}`);
        return;
      }

      renderMembers(Array.isArray(data) ? data : []);
    }

    function renderMembers(rows) {
      const wrap = $("membersList");
      wrap.innerHTML = "";

      if (!rows.length) {
        wrap.innerHTML = `<div class="muted">No members found.</div>`;
        return;
      }

      for (const r of rows) {
        const userId = r.user_id || r.id || r.uid;
        const email = r.email || "(no email)";
        const tier = r.tier || "";
        const active = (r.is_active ?? r.active ?? false);

        const el = document.createElement("div");
        el.className = "member";
        el.innerHTML = `
          <div>
            <div class="email">${email}</div>
            <div class="id">${userId || ""}</div>
          </div>
          <div class="muted">${tier ? `Tier: ${tier}` : ""} ${typeof active === "boolean" ? `• Active: ${active ? "YES" : "NO"}` : ""}</div>
          <button class="primary">Select</button>
        `;
        el.querySelector("button").onclick = () => {
          $("selectedUserId").value = userId || "";
          loadSelected();
        };

        wrap.appendChild(el);
      }
    }

    /******************************************************************
     * SELECTED: BALANCES + LEDGER
     ******************************************************************/
    async function loadSelected() {
      showBanner("");

      const authState = await requireSessionAndAdmin({ redirectIfNoSession: true });
      if (!authState.session) return;
      if (!authState.isAdmin) return;

      const userId = $("selectedUserId").value.trim();
      if (!userId) {
        showBanner("Paste/select a user UUID first.");
        return;
      }

      const { data: balances, error: bErr } = await supabaseClient.rpc("admin_get_user_balances", { p_user_id: userId });
      if (bErr) {
        showBanner(`Balance load failed:\n${bErr.message || JSON.stringify(bErr)}`);
        return;
      }

      const usdCents = balances?.usd_balance_cents ?? balances?.usd_balance ?? balances?.usd ?? 0;
      const btcSats  = balances?.btc_balance_sats ?? balances?.btc_balance ?? balances?.btc ?? 0;

      $("usdBalance").textContent = fmtUsdFromCents(usdCents);
      $("btcBalance").textContent = fmtBtcSats(btcSats);

      const isActive = balances?.is_active;
      if (typeof isActive === "boolean") {
        setSwitchDisabled(false);
        setSwitch(isActive);
        $("activationText").textContent = isActive ? "Activated" : "Pending / Disabled";
        $("activationSub").textContent = isActive ? "Member is active." : "Member is pending (locked).";
      } else {
        $("activationText").textContent = "Activation status unknown";
        $("activationSub").textContent = "Your balances RPC did not return is_active.";
      }

      await loadLedger();
    }

    async function loadLedger() {
      const userId = $("selectedUserId").value.trim();
      if (!userId) return;

      const authState = await requireSessionAndAdmin({ redirectIfNoSession: true });
      if (!authState.session) return;
      if (!authState.isAdmin) return;

      const { data: ledger, error: lErr } = await supabaseClient.rpc("admin_get_user_ledger", { p_user_id: userId });
      if (lErr) {
        showBanner(`Ledger load failed:\n${lErr.message || JSON.stringify(lErr)}`);
        $("ledgerBody").innerHTML = `<tr><td colspan="5" class="muted">Ledger failed to load.</td></tr>`;
        return;
      }

      renderLedger(Array.isArray(ledger) ? ledger : []);
    }

    function renderLedger(rows) {
      const body = $("ledgerBody");
      body.innerHTML = "";

      if (!rows.length) {
        body.innerHTML = `<tr><td colspan="5" class="muted">No ledger entries.</td></tr>`;
        return;
      }

      for (const r of rows) {
        const created = r.created_at || r.time || r.created || "";
        const cur = (r.currency || "").toUpperCase();
        const type = r.entry_type || r.type || "";
        const note = r.note || r.reason || "";

        let amountDisplay = "";
        if (cur === "USD") amountDisplay = fmtUsdFromCents(r.amount_cents ?? r.amount ?? 0);
        else if (cur === "BTC") amountDisplay = fmtBtcSats(r.amount_sats ?? r.amount ?? r.amount_cents ?? 0);
        else amountDisplay = String(r.amount ?? r.amount_cents ?? "");

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="smallMono">${created}</td>
          <td>${cur}</td>
          <td>${type}</td>
          <td class="rightAlign">${amountDisplay}</td>
          <td>${note}</td>
        `;
        body.appendChild(tr);
      }
    }

    /******************************************************************
     * CREDIT / DEBIT
     ******************************************************************/
    async function submitTxn() {
      showBanner("");

      const authState = await requireSessionAndAdmin({ redirectIfNoSession: true });
      if (!authState.session) return;
      if (!authState.isAdmin) return;

      const userId = $("selectedUserId").value.trim();
      if (!userId) return showBanner("Select a member first.");

      const currency = $("currencySelect").value;
      const entryType = $("entryTypeSelect").value; // credit/debit
      const reason = $("reasonInput").value.trim() || "manual_adjust";

      const amountRaw = $("amountInput").value.trim();
      if (!amountRaw) return showBanner("Enter an amount.");

      let metadata = safeJsonParse($("metadataInput").value.trim());
      if (metadata === null) return showBanner("Metadata must be valid JSON.");

      let amountBigint = 0;
      if (currency === "USD") {
        const dollars = Number(amountRaw);
        if (!Number.isFinite(dollars)) return showBanner("USD amount must be a number (e.g. 550).");
        amountBigint = Math.round(dollars * 100);
      } else {
        const sats = Number(amountRaw);
        if (!Number.isFinite(sats)) return showBanner("BTC amount must be a number (sats).");
        amountBigint = Math.round(sats);
      }

      const amt = Math.abs(amountBigint);

      if (entryType === "debit") {
        // Prefer admin_debit_user if it exists (you have it in DB list)
        let didDebit = false;

        {
          const { error } = await supabaseClient.rpc("admin_debit_user", {
            p_user_id: userId,
            p_currency: currency,
            p_amount: amt,
            p_reason: reason,
            p_metadata: metadata || {}
          });

          if (!error) {
            didDebit = true;
          } else {
            // Fallback: negative amount through credit_user (your old behavior)
            const { error: e2 } = await supabaseClient.rpc("admin_credit_user", {
              p_user_id: userId,
              p_currency: currency,
              p_amount: -amt,
              p_reason: reason,
              p_metadata: metadata || {}
            });
            if (e2) return showBanner(`Debit failed:\n${e2.message || JSON.stringify(e2)}`);
            didDebit = true;
          }
        }

        if (!didDebit) return showBanner("Debit failed (unknown).");
      } else {
        const { error } = await supabaseClient.rpc("admin_credit_user", {
          p_user_id: userId,
          p_currency: currency,
          p_amount: amt,
          p_reason: reason,
          p_metadata: metadata || {}
        });
        if (error) return showBanner(`Credit failed:\n${error.message || JSON.stringify(error)}`);
      }

      await loadSelected();
    }

    /******************************************************************
     * ACTIVATION TOGGLE
     ******************************************************************/
    async function toggleActivation() {
      showBanner("");

      const authState = await requireSessionAndAdmin({ redirectIfNoSession: true });
      if (!authState.session) return;
      if (!authState.isAdmin) return;

      const userId = $("selectedUserId").value.trim();
      if (!userId) return showBanner("Select a member first.");

      const isDisabled = $("activationSwitch").getAttribute("aria-disabled") === "true";
      if (isDisabled) return;

      const isOn = $("activationSwitch").classList.contains("on");
      const newVal = !isOn;

      const { error } = await supabaseClient.rpc("admin_set_user_activation", {
        p_is_activated: newVal,
        p_metadata: {},
        p_reason: "admin toggle",
        p_user_id: userId
      });

      if (error) {
        setSwitch(isOn);
        showBanner(`Activation update failed:\n${error.message || JSON.stringify(error)}`);
        return;
      }

      setSwitch(newVal);
      $("activationText").textContent = newVal ? "Activated" : "Pending / Disabled";
      $("activationSub").textContent = newVal ? "Member is active." : "Member is pending (locked).";

      await loadSelected();
    }

    /******************************************************************
     * DEBUG: WHO AM I (optional)
     ******************************************************************/
    async function whoAmI() {
      showBanner("");
      const authState = await requireSessionAndAdmin({ redirectIfNoSession: true });
      if (!authState.session) return;
      if (!authState.isAdmin) return;

      const { data, error } = await supabaseClient.rpc("debug_whoami", {});
      if (error) return showBanner(`debug_whoami failed:\n${error.message || JSON.stringify(error)}`);
      showBanner(`debug_whoami:\n${JSON.stringify(data, null, 2)}`);
    }

    /******************************************************************
     * LOGOUT
     ******************************************************************/
    async function logout() {
      try {
        await supabaseClient.auth.signOut();
      } catch (e) {
        // ignore
      }
      redirectToLogin();
    }

    /******************************************************************
     * WIRE UP
     ******************************************************************/
    $("loadMembersBtn").onclick = loadMembers;
    $("loadSelectedBtn").onclick = loadSelected;
    $("refreshLedgerBtn").onclick = loadLedger;
    $("submitTxnBtn").onclick = submitTxn;
    $("activationSwitch").onclick = toggleActivation;
    $("logoutBtn").onclick = logout;

    $("refreshBtn").onclick = async () => {
      showBanner("");
      const authState = await requireSessionAndAdmin({ redirectIfNoSession: true });
      if (!authState.session || !authState.isAdmin) return;
      await loadMembers();
      const uid = $("selectedUserId").value.trim();
      if (uid) await loadSelected();
    };

    $("debugWhoBtn").onclick = whoAmI;

    // Initial load (hard gate)
    (async function init(){
      const authState = await requireSessionAndAdmin({ redirectIfNoSession: true });
      if (authState.session && authState.isAdmin) {
        // Only show grid for verified admin
        const grid = $("adminGrid");
        if (grid) grid.style.display = "grid";
        setSwitchDisabled(false);
        await loadMembers();
      }
    })();
  </script>
</body>
</html>
