<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin — QFS</title>

  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="robots" content="noindex,nofollow" />

  <style>
    :root{
      --bg:#0b1220; --card:#0f1b33; --muted:#98a2b3; --text:#e6eaf2;
      --line:rgba(255,255,255,.08); --btn:#2563eb; --btn2:#0b3aa6;
      --good:#16a34a; --bad:#ef4444; --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:radial-gradient(1200px 600px at 10% 0%, rgba(37,99,235,.28), transparent 60%), var(--bg); color:var(--text)}
    .wrap{max-width:1180px;margin:0 auto;padding:24px}
    .top{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:18px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:40px;height:40px;border-radius:12px;background:rgba(255,255,255,.06);border:1px solid var(--line);display:flex;align-items:center;justify-content:center;font-weight:800}
    h1{font-size:18px;margin:0}
    .sub{color:var(--muted);font-size:12px;margin-top:2px}
    .grid{display:grid;grid-template-columns: 1.2fr .8fr;gap:14px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:rgba(15,27,51,.82);border:1px solid var(--line);border-radius:16px;padding:16px;backdrop-filter: blur(8px)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{background:var(--btn);border:0;color:white;padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:700}
    .btn:hover{background:var(--btn2)}
    .btn.secondary{background:rgba(255,255,255,.06);border:1px solid var(--line)}
    .btn.danger{background:#7f1d1d}
    .btn.danger:hover{background:#991b1b}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.04);font-size:12px;color:var(--muted)}
    input,select,textarea{
      background:rgba(255,255,255,.06);border:1px solid var(--line);color:var(--text);
      border-radius:12px;padding:10px 12px;outline:none
    }
    input::placeholder,textarea::placeholder{color:rgba(230,234,242,.45)}
    textarea{min-height:72px;resize:vertical}
    .muted{color:var(--muted)}
    .err{color:#fecaca;background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.25);padding:10px 12px;border-radius:12px}
    .ok{color:#bbf7d0;background:rgba(34,197,94,.12);border:1px solid rgba(34,197,94,.25);padding:10px 12px;border-radius:12px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:10px 8px;border-bottom:1px solid var(--line);text-align:left;font-size:13px}
    th{color:var(--muted);font-weight:700}
    tr:hover td{background:rgba(255,255,255,.03)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .right{display:flex;gap:10px;align-items:center;justify-content:flex-end}
    .kpi{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .kpi .box{border:1px solid var(--line);border-radius:14px;padding:12px;background:rgba(255,255,255,.03)}
    .kpi .label{color:var(--muted);font-size:12px}
    .kpi .val{font-weight:900;font-size:18px;margin-top:4px}
    .small{font-size:12px}

    /* ===== Activation toggle (added) ===== */
    .switch{
      position:relative;
      display:inline-block;
      width:42px;
      height:24px;
      vertical-align:middle;
    }
    .switch input{display:none;}
    .slider{
      position:absolute;
      inset:0;
      cursor:pointer;
      background:rgba(255,255,255,.10);
      border:1px solid var(--line);
      transition:.2s;
      border-radius:999px;
    }
    .slider:before{
      content:"";
      position:absolute;
      height:18px;
      width:18px;
      left:3px;
      top:2px;
      background:rgba(255,255,255,.85);
      transition:.2s;
      border-radius:999px;
    }
    .switch input:checked + .slider{
      background:rgba(34,197,94,.22);
      border-color:rgba(34,197,94,.35);
    }
    .switch input:checked + .slider:before{
      transform:translateX(18px);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo">Q</div>
        <div>
          <h1>Admin Console</h1>
          <div class="sub">Credit/Debit USD + BTC (sats) • View balances • View ledger</div>
        </div>
      </div>
      <div class="right">
        <span id="sessionPill" class="pill">Checking session…</span>
        <button class="btn secondary" id="btnRefresh" type="button">Refresh</button>
        <button class="btn danger" id="btnLogout" type="button">Logout</button>
      </div>
    </div>

    <div id="msg" style="margin-bottom:14px;"></div>

    <div class="grid">
      <!-- LEFT: Members list -->
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div>
            <div style="font-weight:900">Members</div>
            <div class="muted small">Select a member to manage balances</div>
          </div>
          <div class="row">
            <input id="search" class="mono" placeholder="Search by user_id (UUID)..." style="min-width:320px" />
            <select id="filterActivation">
              <option value="activated">Activated only</option>
              <option value="all">All</option>
            </select>
          </div>
        </div>

        <table>
          <thead>
            <tr>
              <th>User ID</th>
              <th>Tier</th>
              <th>Activated</th>
              <th>Activated At</th>
              <th>Activate</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="membersBody">
            <tr><td colspan="6" class="muted">Loading…</td></tr>
          </tbody>
        </table>

        <div class="row" style="justify-content:space-between;margin-top:12px">
          <div class="muted small" id="pageInfo">—</div>
          <div class="row">
            <button class="btn secondary" id="prevPage" type="button">Prev</button>
            <button class="btn secondary" id="nextPage" type="button">Next</button>
          </div>
        </div>
      </div>

      <!-- RIGHT: Selected member actions -->
      <div class="card">
        <div style="font-weight:900">Selected Member</div>
        <div class="muted small" style="margin-top:4px">Pick a member on the left, or paste a UUID below.</div>

        <div class="row" style="margin-top:12px">
          <input id="selectedUserId" class="mono" placeholder="Selected user_id (UUID)" style="flex:1;min-width:280px" />
          <button class="btn secondary" id="loadBalances" type="button">Load</button>
        </div>

        <div class="kpi">
          <div class="box">
            <div class="label">USD Balance</div>
            <div class="val" id="usdBal">$0.00</div>
            <div class="muted small">stored as cents</div>
          </div>
          <div class="box">
            <div class="label">BTC Balance</div>
            <div class="val" id="btcBal">0 sats</div>
            <div class="muted small">stored as sats</div>
          </div>
        </div>

        <hr style="border:0;border-top:1px solid var(--line);margin:14px 0" />

        <div class="row">
          <select id="currency">
            <option value="USD">USD</option>
            <option value="BTC">BTC</option>
          </select>

          <input id="amount" placeholder="Amount (USD in dollars, BTC in sats)" style="flex:1;min-width:240px" />

          <select id="action">
            <option value="credit">Credit</option>
            <option value="debit">Debit</option>
          </select>
        </div>

        <div class="row" style="margin-top:10px">
          <input id="reason" placeholder="Reason (e.g. welcome_credit, manual_adjust)" style="flex:1;min-width:260px" />
        </div>

        <div class="row" style="margin-top:10px">
          <textarea id="note" placeholder='Optional note/metadata (saved). Example: {"note":"manual top up"}'></textarea>
        </div>

        <div class="row" style="margin-top:12px;justify-content:space-between">
          <div class="muted small">USD is converted to cents automatically. BTC expects sats.</div>
          <button class="btn" id="submitTxn" type="button">Submit</button>
        </div>

        <hr style="border:0;border-top:1px solid var(--line);margin:14px 0" />

        <div class="row" style="justify-content:space-between">
          <div>
            <div style="font-weight:900">Recent Ledger</div>
            <div class="muted small">Last 25 entries (selected currency filter)</div>
          </div>
          <button class="btn secondary" id="refreshLedger" type="button">Refresh</button>
        </div>

        <div style="margin-top:10px;max-height:320px;overflow:auto;border:1px solid var(--line);border-radius:14px;background:rgba(255,255,255,.03)">
          <table style="margin:0">
            <thead>
              <tr>
                <th>Time</th>
                <th>Cur</th>
                <th>Type</th>
                <th>Amount</th>
                <th>Reason</th>
              </tr>
            </thead>
            <tbody id="ledgerBody">
              <tr><td colspan="5" class="muted">No member selected.</td></tr>
            </tbody>
          </table>
        </div>

      </div>
    </div>
  </div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // ======== CONFIG ========
    const SUPABASE_URL = "https://qagktukzxtwbjrdgiben.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFhZ2t0dWt6eHR3YmpyZGdpYmVuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4NDA0NTQsImV4cCI6MjA4MzQxNjQ1NH0.cbhSWHGlmhmIt-NmUVBUtAhPpNPDKk4Bz-Gy1TbPzHk";

    const sb = window.__sb || (window.__sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY));
    const el = (id) => document.getElementById(id);

    function setMsg(type, text) {
      const box = el("msg");
      if (!text) { box.innerHTML = ""; return; }
      box.innerHTML = `<div class="${type === "ok" ? "ok" : "err"}">${text}</div>`;
    }

    function fmtUsdFromCents(cents) {
      const n = Number(cents || 0);
      const dollars = (n / 100).toFixed(2);
      return "$" + dollars;
    }

    function fmtSats(s) {
      const n = Number(s || 0);
      return `${n.toLocaleString()} sats`;
    }

    function safeJsonParse(str) {
      const t = (str || "").trim();
      if (!t) return {};
      try { return JSON.parse(t); } catch { return { note_raw: t }; }
    }

    // ======== AUTH / ADMIN CHECK ========
    async function requireSession() {
      const { data, error } = await sb.auth.getSession();
      if (error) {
        el("sessionPill").textContent = "Session error";
        setMsg("err", "Session read failed: " + error.message);
        return null;
      }

      const session = data?.session || null;
      if (!session) {
        el("sessionPill").textContent = "Not logged in";
        setMsg("err", "You are not logged in. Redirecting to admin-confirm…");
        setTimeout(() => { window.location.href = "admin-confirm.html"; }, 700);
        return null;
      }

      el("sessionPill").textContent = "Logged in";
      return session;
    }

    async function requireAdmin() {
      const { data, error } = await sb.rpc("is_admin");
      if (error) {
        setMsg("err", "Admin check failed: " + error.message);
        return false;
      }
      if (data !== true) {
        setMsg("err", "Not authorized: your account is not an admin.");
        return false;
      }
      return true;
    }

    // ======== MEMBERS LIST ========
    let pageLimit = 25;
    let pageOffset = 0;
    let cachedMembers = [];

    async function setActivation(uid, nextActive, checkboxEl) {
      if (!uid) return;

      if (checkboxEl) checkboxEl.disabled = true;
      setMsg("", "");

      // ✅ FIXED: correct param names + correct variables
      const { error } = await sb.rpc("admin_set_user_activation", {
        p_user_id: uid,
        p_is_activated: nextActive,
        p_reason: "admin_toggle",
        p_metadata: {}
      });

      if (error) {
        if (checkboxEl) {
          checkboxEl.checked = !nextActive;
          checkboxEl.disabled = false;
        }
        setMsg("err", "Activation update failed: " + error.message);
        return;
      }

      await loadMembers();
      if (checkboxEl) checkboxEl.disabled = false;

      setMsg("ok", `User ${uid} ${nextActive ? "activated" : "deactivated"}.`);
    }

    function renderMembers(rows) {
      const body = el("membersBody");
      if (!rows || rows.length === 0) {
        body.innerHTML = `<tr><td colspan="6" class="muted">No members found.</td></tr>`;
        return;
      }

      body.innerHTML = rows.map(r => {
        const act = r.is_activated ? "Yes" : "No";
        const actAt = r.activated_at ? new Date(r.activated_at).toLocaleString() : "—";
        const checked = r.is_activated ? "checked" : "";
        return `
          <tr>
            <td class="mono">${r.user_id}</td>
            <td>${r.tier || "—"}</td>
            <td>${act}</td>
            <td>${actAt}</td>
            <td>
              <label class="switch" title="Toggle activation">
                <input type="checkbox" data-activate="${r.user_id}" ${checked} />
                <span class="slider"></span>
              </label>
            </td>
            <td><button class="btn secondary small" type="button" data-pick="${r.user_id}">Select</button></td>
          </tr>
        `;
      }).join("");

      [...body.querySelectorAll("[data-pick]")].forEach(btn => {
        btn.addEventListener("click", async () => {
          const uid = btn.getAttribute("data-pick");
          el("selectedUserId").value = uid;
          await loadBalancesAndLedger();
        });
      });

      [...body.querySelectorAll("input[data-activate]")].forEach(chk => {
        chk.addEventListener("change", async () => {
          const uid = chk.getAttribute("data-activate");
          const next = chk.checked;
          await setActivation(uid, next, chk);
        });
      });
    }

    function applySearchAndFilter() {
      const q = (el("search").value || "").trim().toLowerCase();
      const f = el("filterActivation").value;

      let rows = [...cachedMembers];
      if (f === "activated") rows = rows.filter(r => r.is_activated === true);
      if (q) rows = rows.filter(r => String(r.user_id || "").toLowerCase().includes(q));

      renderMembers(rows);
      el("pageInfo").textContent = `Loaded ${cachedMembers.length} members (page offset ${pageOffset})`;
    }

    async function loadMembers() {
      setMsg("", "");
      const { data, error } = await sb.rpc("admin_list_members", { p_limit: pageLimit, p_offset: pageOffset });
      if (error) {
        setMsg("err", "Failed to load members: " + error.message);
        el("membersBody").innerHTML = `<tr><td colspan="6" class="muted">Error loading members.</td></tr>`;
        return;
      }
      cachedMembers = Array.isArray(data) ? data : [];
      applySearchAndFilter();
    }

    // ======== BALANCES + LEDGER ========
    async function loadBalancesAndLedger() {
      const userId = (el("selectedUserId").value || "").trim();
      if (!userId) {
        setMsg("err", "Paste/select a user_id first.");
        return;
      }

      const { data: bal, error: balErr } = await sb.rpc("admin_get_user_balances", { p_user_id: userId });
      if (balErr) {
        setMsg("err", "Balance load failed: " + balErr.message);
        return;
      }
      el("usdBal").textContent = fmtUsdFromCents(bal?.usd_cents);
      el("btcBal").textContent = fmtSats(bal?.btc_sats);

      await loadLedger();
    }

    async function loadLedger() {
      const userId = (el("selectedUserId").value || "").trim();
      if (!userId) return;

      const cur = (el("currency").value || "USD").toUpperCase();
      const { data, error } = await sb.rpc("admin_get_user_ledger", {
        p_user_id: userId,
        p_currency: cur,
        p_limit: 25
      });

      if (error) {
        setMsg("err", "Ledger load failed: " + error.message);
        return;
      }

      const body = el("ledgerBody");
      const rows = Array.isArray(data) ? data : [];
      if (rows.length === 0) {
        body.innerHTML = `<tr><td colspan="5" class="muted">No ledger entries.</td></tr>`;
        return;
      }

      body.innerHTML = rows.map(r => {
        const time = r.created_at ? new Date(r.created_at).toLocaleString() : "—";
        const amt = r.currency === "USD"
          ? fmtUsdFromCents(r.amount_units)
          : fmtSats(r.amount_units);

        return `
          <tr>
            <td class="small">${time}</td>
            <td>${r.currency}</td>
            <td>${r.entry_type}</td>
            <td class="mono">${amt}</td>
            <td>${r.reason}</td>
          </tr>
        `;
      }).join("");
    }

    // ======== CREDIT/DEBIT SUBMIT ========
    async function submitTxn() {
      const userId = (el("selectedUserId").value || "").trim();
      if (!userId) { setMsg("err", "Select/paste a user_id first."); return; }

      const currency = (el("currency").value || "USD").toUpperCase();
      const action = (el("action").value || "credit").toLowerCase();
      const reason = (el("reason").value || "").trim() || (action === "credit" ? "admin_credit" : "admin_debit");
      const noteMeta = safeJsonParse(el("note").value);

      const rawAmount = (el("amount").value || "").trim();
      if (!rawAmount) { setMsg("err", "Enter an amount."); return; }

      let amountUnits = 0;

      if (currency === "USD") {
        const dollars = Number(rawAmount);
        if (!Number.isFinite(dollars) || dollars <= 0) { setMsg("err", "USD amount must be a positive number (dollars)."); return; }
        amountUnits = Math.round(dollars * 100);
      } else {
        const sats = Number(rawAmount);
        if (!Number.isFinite(sats) || sats <= 0 || !Number.isInteger(sats)) { setMsg("err", "BTC amount must be a positive whole number (sats)."); return; }
        amountUnits = sats;
      }

      setMsg("", "");

      const rpcName = action === "debit" ? "admin_debit_user" : "admin_credit_user";
      const { data, error } = await sb.rpc(rpcName, {
        p_user_id: userId,
        p_currency: currency,
        p_amount_units: amountUnits,
        p_reason: reason,
        p_metadata: noteMeta
      });

      if (error) {
        setMsg("err", "Transaction failed: " + error.message);
        return;
      }

      setMsg("ok", `Success: ${rpcName} • ${currency} • ${currency === "USD" ? fmtUsdFromCents(amountUnits) : fmtSats(amountUnits)} • entry/ref: ${data?.entry_id || data?.ref || "ok"}`);
      await loadBalancesAndLedger();
    }

    // ======== UI EVENTS ========
    el("btnLogout").addEventListener("click", async () => {
      try { await sb.auth.signOut(); } catch {}
      window.location.href = "admin-confirm.html";
    });

    el("btnRefresh").addEventListener("click", async () => {
      setMsg("", "");
      await boot();
    });

    el("prevPage").addEventListener("click", async () => {
      pageOffset = Math.max(0, pageOffset - pageLimit);
      await loadMembers();
    });

    el("nextPage").addEventListener("click", async () => {
      pageOffset = pageOffset + pageLimit;
      await loadMembers();
    });

    el("search").addEventListener("input", () => applySearchAndFilter());
    el("filterActivation").addEventListener("change", () => applySearchAndFilter());

    el("loadBalances").addEventListener("click", async () => {
      await loadBalancesAndLedger();
    });

    el("refreshLedger").addEventListener("click", async () => {
      await loadLedger();
    });

    el("currency").addEventListener("change", async () => {
      await loadLedger();
    });

    el("submitTxn").addEventListener("click", async () => {
      await submitTxn();
    });

    // ======== BOOT ========
    async function boot() {
      el("sessionPill").textContent = "Checking session…";

      const session = await requireSession();
      if (!session) return;

      const okAdmin = await requireAdmin();
      if (!okAdmin) return;

      await loadMembers();
      setMsg("ok", "Admin console ready.");
    }

    boot();
  </script>
</body>
</html>
