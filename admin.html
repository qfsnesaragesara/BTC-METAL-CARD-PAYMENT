<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin — QFS</title>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#071024; color:#e8eefc; }
    .topbar { display:flex; align-items:center; justify-content:space-between; padding:18px 24px; border-bottom:1px solid rgba(255,255,255,.08); }
    .pill { padding:6px 10px; border:1px solid rgba(255,255,255,.15); border-radius:999px; font-size:12px; opacity:.9 }
    .wrap { max-width:1100px; margin:0 auto; padding:24px; }
    .banner { margin:16px 0; padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06); }
    .banner.err { border-color: rgba(255,80,80,.35); background: rgba(255,80,80,.12); }
    .grid { display:grid; grid-template-columns: 1.25fr 1fr; gap:18px; }
    .card { border-radius:16px; border:1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.05); padding:16px; }
    h2 { margin:0 0 8px; font-size:16px; }
    .sub { margin:0 0 14px; opacity:.8; font-size:12px; }
    .row { display:flex; gap:10px; align-items:center; }
    input, select, button, textarea {
      background: rgba(0,0,0,.25);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 10px;
      padding: 10px 12px;
      color: #e8eefc;
      outline: none;
    }
    input::placeholder, textarea::placeholder { color: rgba(232,238,252,.55); }
    button { cursor:pointer; background: rgba(90,140,255,.25); border-color: rgba(90,140,255,.35); }
    button:hover { background: rgba(90,140,255,.35); }
    .list { margin-top:12px; border-top:1px solid rgba(255,255,255,.08); }
    .member { display:grid; grid-template-columns: 1.6fr .7fr .5fr .7fr .5fr; gap:10px; padding:12px 0; border-bottom:1px solid rgba(255,255,255,.08); align-items:center; }
    .muted { opacity:.75; font-size:12px; }
    .small { font-size:12px; opacity:.85; }
    .toggle {
      width:46px; height:26px; border-radius:999px; position:relative; border:1px solid rgba(255,255,255,.15);
      background: rgba(255,255,255,.08);
    }
    .toggle input { display:none; }
    .knob { width:22px; height:22px; position:absolute; top:1px; left:1px; border-radius:999px; background: rgba(255,255,255,.85); transition: transform .15s ease; }
    .toggle.on { background: rgba(60,220,160,.18); border-color: rgba(60,220,160,.35); }
    .toggle.on .knob { transform: translateX(20px); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:12px; }
    .right { text-align:right; }
  </style>

  <!-- Supabase UMD -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
  <div class="topbar">
    <div>
      <div style="font-weight:700">Admin Console</div>
      <div class="muted">Credit/Debit USD + BTC (sats) · View balances · View ledger</div>
    </div>
    <div class="row">
      <span id="statusPill" class="pill">Loading…</span>
      <button id="btnRefresh">Refresh</button>
      <button id="btnLogout">Logout</button>
    </div>
  </div>

  <div class="wrap">
    <div id="banner" class="banner" style="display:none"></div>

    <div class="grid">
      <!-- Members -->
      <div class="card">
        <h2>Members</h2>
        <p class="sub">Select a member to manage balances</p>

        <div class="row">
          <input id="search" placeholder="Search by user_id (UUID)..." style="flex:1" />
          <select id="filter">
            <option value="all">All</option>
            <option value="activated">Activated only</option>
            <option value="inactive">Inactive only</option>
          </select>
          <button id="btnLoadMembers">Load</button>
        </div>

        <div class="list">
          <div class="member muted" style="border-bottom:1px solid rgba(255,255,255,.12); padding-bottom:10px;">
            <div>User ID</div><div>Tier</div><div>Activated</div><div>Activated At</div><div class="right">Activate</div>
          </div>
          <div id="members"></div>
          <div class="muted" id="membersMeta" style="padding-top:10px;">—</div>
        </div>
      </div>

      <!-- Selected member -->
      <div class="card">
        <h2>Selected Member</h2>
        <p class="sub">Pick a member on the left, or paste a UUID below.</p>

        <div class="row">
          <input id="selectedUserId" placeholder="Selected user_id (UUID)" style="flex:1" />
          <button id="btnLoadSelected">Load</button>
        </div>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px;">
          <div class="card" style="padding:12px;">
            <div class="muted">USD Balance</div>
            <div style="font-size:20px; font-weight:700" id="usdBal">$0.00</div>
            <div class="muted">stored as cents</div>
          </div>
          <div class="card" style="padding:12px;">
            <div class="muted">BTC Balance</div>
            <div style="font-size:20px; font-weight:700" id="btcBal">0 sats</div>
            <div class="muted">stored as sats</div>
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <select id="cur">
            <option value="USD">USD</option>
            <option value="BTC">BTC</option>
          </select>
          <input id="amount" placeholder="Amount (USD dollars, BTC in sats)" style="flex:1" />
        </div>

        <div class="row" style="margin-top:10px;">
          <select id="type">
            <option value="credit">Credit</option>
            <option value="debit">Debit</option>
          </select>
          <input id="reason" placeholder="Reason (e.g. welcome_credit, manual_adjust)" style="flex:1" />
        </div>

        <textarea id="metadata" rows="4" style="margin-top:10px; width:100%; resize:vertical"
          placeholder='Optional note/metadata (saved). Example:
{"note":"manual top up"}'></textarea>

        <div class="row" style="margin-top:10px; justify-content:space-between;">
          <div class="muted">USD is converted to cents automatically. BTC expects sats.</div>
          <button id="btnSubmit">Submit</button>
        </div>

        <div style="margin-top:14px;">
          <div class="row" style="justify-content:space-between; align-items:flex-end;">
            <div>
              <div style="font-weight:700">Recent Ledger</div>
              <div class="muted">Last 25 entries (selected currency filter)</div>
            </div>
            <button id="btnRefreshLedger">Refresh</button>
          </div>
          <div id="ledger" class="muted" style="margin-top:8px;">No member selected.</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========= CONFIG (fill these) =========
    const SUPABASE_URL = "YOUR_SUPABASE_URL";
    const SUPABASE_ANON_KEY = "YOUR_SUPABASE_ANON_KEY";
    // ======================================

    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const el = (id) => document.getElementById(id);
    const banner = el("banner");
    const statusPill = el("statusPill");
    const membersEl = el("members");
    const membersMeta = el("membersMeta");

    let session = null;
    let selectedUserId = null;

    function showBanner(msg, isErr=false) {
      banner.style.display = "block";
      banner.className = "banner" + (isErr ? " err" : "");
      banner.textContent = msg;
    }
    function clearBanner() {
      banner.style.display = "none";
      banner.textContent = "";
    }

    async function ensureSessionReady() {
      // IMPORTANT: wait for session hydration on refresh/incognito
      const { data, error } = await sb.auth.getSession();
      if (error) throw error;
      session = data.session;
      if (!session) throw new Error("Not authenticated (no session).");
      return session;
    }

    async function ensureAdmin() {
      await ensureSessionReady();
      const { data, error } = await sb.rpc("is_admin");
      if (error) throw error;
      if (!data) throw new Error("Not authorized: your account is not an admin.");
      return true;
    }

    function renderMembers(rows) {
      membersEl.innerHTML = "";
      for (const r of rows) {
        const row = document.createElement("div");
        row.className = "member";
        const activated = !!r.is_active;
        row.innerHTML = `
          <div class="mono">${r.id || ""}</div>
          <div class="small">${r.tier || "-"}</div>
          <div class="small">${activated ? "Yes" : "No"}</div>
          <div class="small">${r.activated_at || r.created_at || "-"}</div>
          <div class="right">
            <label class="toggle ${activated ? "on" : ""}">
              <input type="checkbox" ${activated ? "checked" : ""} />
              <span class="knob"></span>
            </label>
          </div>
        `;

        // Select on click (except toggle)
        row.addEventListener("click", (e) => {
          if (e.target && (e.target.tagName === "INPUT" || e.target.classList.contains("knob"))) return;
          selectedUserId = r.id;
          el("selectedUserId").value = r.id;
          loadSelected();
        });

        // Toggle activation
        const toggle = row.querySelector("label.toggle");
        const input = row.querySelector("input[type=checkbox]");
        input.addEventListener("change", async () => {
          clearBanner();
          try {
            await ensureAdmin();

            const newState = input.checked;

            // RPC call with EXACT parameter names
            const { error } = await sb.rpc("admin_set_user_activation", {
              p_user_id: r.id,
              p_is_activated: newState,
              p_reason: "admin_toggle",
              p_metadata: {}
            });

            if (error) throw error;

            // update UI state
            toggle.classList.toggle("on", newState);
            await loadMembers(); // refresh list from DB
          } catch (e) {
            // rollback UI toggle if fail
            input.checked = !input.checked;
            toggle.classList.toggle("on", input.checked);
            showBanner("Activation update failed: " + (e?.message || String(e)), true);
          }
        });

        membersEl.appendChild(row);
      }
    }

    async function loadMembers() {
      clearBanner();
      try {
        await ensureAdmin();
        statusPill.textContent = "Admin OK";

        const filter = el("filter").value;
        const search = (el("search").value || "").trim();

        // Use your existing RPC if you have it
        // Expected return fields: id, tier, is_active, created_at (and optionally activated_at)
        const { data, error } = await sb.rpc("admin_list_members", {
          p_filter: filter,
          p_search: search
        });

        if (error) throw error;

        renderMembers(data || []);
        membersMeta.textContent = `Loaded ${data?.length || 0} members.`;
      } catch (e) {
        statusPill.textContent = "Not authorized";
        renderMembers([]);
        membersMeta.textContent = "—";
        showBanner(e?.message || String(e), true);
      }
    }

    async function loadSelected() {
      clearBanner();
      try {
        await ensureAdmin();

        const uid = (el("selectedUserId").value || "").trim();
        if (!uid) return;

        selectedUserId = uid;

        // balances
        const { data: bal, error: balErr } = await sb.rpc("admin_get_user_balances", { p_user_id: uid });
        if (balErr) throw balErr;

        const usd = Number(bal?.usd_cents || 0) / 100;
        el("usdBal").textContent = usd.toLocaleString(undefined, { style:"currency", currency:"USD" });
        el("btcBal").textContent = `${Number(bal?.btc_sats || 0).toLocaleString()} sats`;

        // ledger (optional)
        await loadLedger();
      } catch (e) {
        showBanner(e?.message || String(e), true);
      }
    }

    async function loadLedger() {
      const uid = selectedUserId;
      if (!uid) { el("ledger").textContent = "No member selected."; return; }

      const cur = el("cur").value;
      const { data, error } = await sb.rpc("admin_get_user_ledger", { p_user_id: uid, p_currency: cur, p_limit: 25 });
      if (error) throw error;

      if (!data || data.length === 0) {
        el("ledger").textContent = "No ledger entries.";
        return;
      }

      const lines = data.map(x => {
        const amt = (cur === "USD")
          ? (Number(x.amount_cents || 0) / 100).toLocaleString(undefined, { style:"currency", currency:"USD" })
          : `${Number(x.amount_sats || 0).toLocaleString()} sats`;
        return `${x.created_at} | ${x.entry_type} | ${amt} | ${x.reason || ""}`;
      });

      el("ledger").innerHTML = `<div class="mono" style="white-space:pre-wrap; line-height:1.5">${lines.join("\n")}</div>`;
    }

    async function submitAdjust() {
      clearBanner();
      try {
        await ensureAdmin();

        const uid = (el("selectedUserId").value || "").trim();
        if (!uid) throw new Error("Select a member first.");

        const currency = el("cur").value;
        const type = el("type").value; // credit/debit
        const reason = (el("reason").value || "").trim() || "manual_adjust";
        const amtRaw = (el("amount").value || "").trim();

        if (!amtRaw) throw new Error("Enter an amount.");

        let amountBigInt;
        if (currency === "USD") {
          // USD entered as dollars (can include decimals)
          const dollars = Number(amtRaw);
          if (!Number.isFinite(dollars)) throw new Error("Invalid USD amount.");
          amountBigInt = BigInt(Math.round(dollars * 100));
        } else {
          // BTC entered as sats integer
          const sats = Number(amtRaw);
          if (!Number.isFinite(sats)) throw new Error("Invalid BTC sats.");
          amountBigInt = BigInt(Math.trunc(sats));
        }

        let metadata = {};
        const metaRaw = (el("metadata").value || "").trim();
        if (metaRaw) {
          try { metadata = JSON.parse(metaRaw); }
          catch { throw new Error("Metadata must be valid JSON."); }
        }

        const fn = (type === "credit") ? "admin_credit_user" : "admin_debit_user";

        const { error } = await sb.rpc(fn, {
          p_user_id: uid,
          p_currency: currency,
          p_amount: amountBigInt.toString(),
          p_reason: reason,
          p_metadata: metadata
        });

        if (error) throw error;

        await loadSelected();
        showBanner("Success.", false);
      } catch (e) {
        showBanner(e?.message || String(e), true);
      }
    }

    async function logout() {
      await sb.auth.signOut();
      statusPill.textContent = "Logged out";
      showBanner("Logged out.", false);
      membersEl.innerHTML = "";
    }

    // Events
    el("btnLoadMembers").addEventListener("click", loadMembers);
    el("btnLoadSelected").addEventListener("click", loadSelected);
    el("btnSubmit").addEventListener("click", submitAdjust);
    el("btnRefreshLedger").addEventListener("click", loadLedger);
    el("btnRefresh").addEventListener("click", () => { loadMembers(); loadSelected(); });
    el("btnLogout").addEventListener("click", logout);

    // Auth restore + rerender
    sb.auth.onAuthStateChange(async (_event, _session) => {
      session = _session;
      if (!session) {
        statusPill.textContent = "Not logged in";
        return;
      }
      // Only run once session exists
      try {
        await ensureAdmin();
        statusPill.textContent = "Admin OK";
        await loadMembers();
      } catch (e) {
        statusPill.textContent = "Not authorized";
        showBanner(e?.message || String(e), true);
      }
    });

    // Initial load (wait for session hydration!)
    (async () => {
      clearBanner();
      try {
        statusPill.textContent = "Checking session…";
        await ensureSessionReady();
        await ensureAdmin();
        statusPill.textContent = "Admin OK";
        await loadMembers();
      } catch (e) {
        statusPill.textContent = "Not authorized";
        showBanner(e?.message || String(e), true);
      }
    })();
  </script>
</body>
</html>
