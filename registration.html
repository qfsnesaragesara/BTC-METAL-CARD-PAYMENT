<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Registration Form — QFS NESARA GESARA</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Favicon -->
  <link rel="icon" type="image/png"
        href="https://raw.githubusercontent.com/qfsnesaragesara/BTC-METAL-CARD-PAYMENT/main/photo%201.jpg">

  <style>
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      background:
        radial-gradient(circle at top, rgba(56,189,248,0.35), transparent 55%),
        radial-gradient(circle at bottom, rgba(147,51,234,0.35), transparent 60%),
        #020617;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px 16px;
    }
  </style>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>

  <div class="w-full max-w-2xl bg-white p-8 rounded-2xl shadow-2xl">
    <h2 class="text-2xl font-bold text-center mb-2">QFS Registration Form</h2>
    <p class="text-center text-slate-600 mb-6 text-sm">
      Create your portal login password below. After submitting, you can sign in on the Login page.
    </p>

    <form id="regForm"
          action="https://formsubmit.co/support@qfsnesaragesara.org"
          method="POST"
          class="space-y-6">

      <input type="hidden" name="_next" value="https://qfsnesaragesara.org/success-registration.html">
      <input type="hidden" name="_captcha" value="false">
      <input type="hidden" name="_template" value="table">
      <input type="text" name="_honey" class="hidden" style="display:none">

      <!-- NAME -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="font-semibold">First Name</label>
          <input id="firstName" type="text" name="first_name" required class="w-full mt-1 p-3 border rounded-lg">
        </div>
        <div>
          <label class="font-semibold">Middle Name</label>
          <input id="middleName" type="text" name="middle_name" class="w-full mt-1 p-3 border rounded-lg">
        </div>
        <div>
          <label class="font-semibold">Last Name</label>
          <input id="lastName" type="text" name="last_name" required class="w-full mt-1 p-3 border rounded-lg">
        </div>
      </div>

      <!-- DOB / PHONE / GENDER -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="font-semibold">Date of Birth</label>
          <input type="date" name="dob" required class="w-full mt-1 p-3 border rounded-lg">
        </div>
        <div>
          <label class="font-semibold">Phone Number</label>
          <input type="tel" name="phone" required class="w-full mt-1 p-3 border rounded-lg">
        </div>
        <div>
          <label class="font-semibold">Gender</label>
          <select name="gender" required class="w-full mt-1 p-3 border rounded-lg">
            <option value="">Select…</option>
            <option>Male</option>
            <option>Female</option>
            <option>Non-Binary</option>
            <option>Other</option>
          </select>
        </div>
      </div>

      <!-- EMAIL + OPTIONAL -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="font-semibold">Email Address</label>
          <input id="regEmail" type="email" name="email" required class="w-full mt-1 p-3 border rounded-lg">
        </div>
        <div>
          <label class="font-semibold">A Number (Optional)</label>
          <input type="text" name="a_number" class="w-full mt-1 p-3 border rounded-lg">
        </div>
      </div>

      <!-- PASSWORD -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="font-semibold">Create Password</label>
          <input id="regPass1" type="password" required class="w-full mt-1 p-3 border rounded-lg"
                 placeholder="Minimum 8 characters" autocomplete="new-password">
        </div>
        <div>
          <label class="font-semibold">Confirm Password</label>
          <input id="regPass2" type="password" required class="w-full mt-1 p-3 border rounded-lg"
                 placeholder="Repeat password" autocomplete="new-password">
        </div>
      </div>

      <!-- REGISTERING FOR -->
      <div>
        <label class="font-semibold">What are you registering for?</label>
        <select id="regFor" name="registering_for" required class="w-full mt-1 p-3 border rounded-lg">
          <option value="">Select one…</option>

          <!-- ✅ gold option is easy to find + hide -->
          <option id="goldOption" value="Trump Gold Card Program">
            Trump Gold Card Program ( Unlock life in America )
          </option>

          <option value="Physical Bitcoin Metal Card (Silver $25,000)">
            Physical Bitcoin Metal Card Silver ( Preloaded with $25,000 worth of Bitcoin)
          </option>
          <option value="Physical Bitcoin Metal Card (Black 25,000 BTC)">
            Physical Bitcoin Metal Card Black ( Preloaded with 25,000 Bitcoin )
          </option>
          <option value="MedBeds Application Fees $2000 - $5000">
            MedBeds Aplication Fees Applicable
          </option>
        </select>

        <!-- optional note -->
        <p id="goldHiddenNote" class="text-xs text-slate-500 mt-2 hidden">
          Gold Card is not available for United States users.
        </p>
      </div>

      <!-- PAYMENT OPTION -->
      <div>
        <label class="font-semibold">Payment Option</label>
        <select name="payment_option" required class="w-full mt-1 p-3 border rounded-lg">
          <option value="">Select payment option…</option>
          <option>Full Payment</option>
          <option>Bridge Payment</option>
        </select>
      </div>

      <!-- BIRTH DETAILS -->
      <h3 class="text-lg font-bold mt-4">Birth Information</h3>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="font-semibold">Place of Birth</label>
          <input type="text" name="place_of_birth" required class="w-full mt-1 p-3 border rounded-lg">
        </div>
        <div>
          <label class="font-semibold">City of Birth</label>
          <input type="text" name="city_of_birth" required class="w-full mt-1 p-3 border rounded-lg">
        </div>
        <div>
          <label class="font-semibold">State/Province of Birth</label>
          <input type="text" name="state_of_birth" required class="w-full mt-1 p-3 border rounded-lg">
        </div>
      </div>

      <div>
        <label class="font-semibold">Country of Birth</label>
        <input type="text" name="country_of_birth" required class="w-full mt-1 p-3 border rounded-lg">
      </div>

      <div>
        <label class="font-semibold">Country of Citizenship</label>
        <input type="text" name="citizenship_country" required class="w-full mt-1 p-3 border rounded-lg">
      </div>

      <!-- ADDRESS -->
      <h3 class="text-lg font-bold mt-4">Physical Address</h3>

      <div>
        <label class="font-semibold">Street Address</label>
        <input type="text" name="street_address" required class="w-full mt-1 p-3 border rounded-lg">
      </div>

      <div>
        <label class="font-semibold">Apartment / Suite</label>
        <input type="text" name="apartment" class="w-full mt-1 p-3 border rounded-lg">
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="font-semibold">City</label>
          <input type="text" name="city" required class="w-full mt-1 p-3 border rounded-lg">
        </div>
        <div>
          <label class="font-semibold">State / Province</label>
          <input type="text" name="state" required class="w-full mt-1 p-3 border rounded-lg">
        </div>
        <div>
          <label class="font-semibold">ZIP / Postal Code</label>
          <input type="text" name="zip" required class="w-full mt-1 p-3 border rounded-lg">
        </div>
      </div>

      <!-- ✅ add id so JS can read what they type -->
      <div>
        <label class="font-semibold">Country</label>
        <input id="countryEl" type="text" name="country" required class="w-full mt-1 p-3 border rounded-lg">
      </div>

      <!-- FAMILY -->
      <div>
        <label class="font-semibold">Number of Family Members (Spouse or Children under 21)</label>
        <input type="number" name="family_members" min="0" required class="w-full mt-1 p-3 border rounded-lg">
      </div>

      <div id="regMsg" class="text-sm text-center hidden"></div>

      <button id="regSubmit" type="submit"
              class="w-full bg-blue-600 text-white font-semibold p-3 rounded-lg hover:bg-blue-700 transition">
        Submit Registration
      </button>
    </form>
  </div>

<script>
(() => {
  const SUPABASE_URL = "https://qagktukzxtwbjrdgiben.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFhZ2t0dWt6eHR3YmpyZGdpYmVuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4NDA0NTQsImV4cCI6MjA4MzQxNjQ1NH0.cbhSWHGlmhmIt-NmUVBUtAhPpNPDKk4Bz-Gy1TbPzHk";

  const supabase = (window.__qfsSupabase ||= window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY));

  const form = document.getElementById("regForm");
  const emailEl = document.getElementById("regEmail");
  const p1 = document.getElementById("regPass1");
  const p2 = document.getElementById("regPass2");
  const regFor = document.getElementById("regFor");
  const msg = document.getElementById("regMsg");
  const btn = document.getElementById("regSubmit");

  const firstNameEl = document.getElementById("firstName");
  const middleNameEl = document.getElementById("middleName");
  const lastNameEl = document.getElementById("lastName");

  // ✅ NEW: Country + gold option refs
  const countryEl = document.getElementById("countryEl");
  const goldOption = document.getElementById("goldOption");
  const goldHiddenNote = document.getElementById("goldHiddenNote");

  function show(text, ok=true){
    msg.className = "text-sm text-center " + (ok ? "text-emerald-600" : "text-red-600");
    msg.textContent = text;
    msg.classList.remove("hidden");
  }

  // ✅ detect USA even if they type variations
  function isUnitedStates(v){
    const s = String(v || "").trim().toLowerCase().replace(/\./g, "");
    if(!s) return false;

    const cleaned = s.replace(/\s+/g, " ");
    return (
      cleaned === "united states" ||
      cleaned === "united states of america" ||
      cleaned === "usa" ||
      cleaned === "us" ||
      cleaned === "u s" ||
      cleaned === "u s a" ||
      cleaned === "america" ||
      cleaned === "the united states"
    );
  }

  function setGoldVisibility(){
    if(!goldOption) return;

    const usa = isUnitedStates(countryEl?.value);

    // If USA: hide gold option and reset selection if it was selected.
    goldOption.hidden = usa;
    goldOption.disabled = usa;

    if(goldHiddenNote){
      goldHiddenNote.classList.toggle("hidden", !usa);
    }

    // If they already picked gold then typed USA -> force them off gold
    if(usa && regFor && regFor.value === goldOption.value){
      regFor.value = "";
    }
  }

  // run on load + when they type/paste
  if(countryEl){
    countryEl.addEventListener("input", setGoldVisibility);
    countryEl.addEventListener("change", setGoldVisibility);
  }
  // run once on boot
  setGoldVisibility();

  function inferTierFromRegisteringFor(registeringForText) {
    const v = (registeringForText || "").toLowerCase();
    if (v.includes("gold")) return "gold";
    if (v.includes("black")) return "black";
    if (v.includes("silver")) return "silver";
    return "silver";
  }

  async function postFormSubmit() {
    const action = form.getAttribute("action");
    const method = (form.getAttribute("method") || "POST").toUpperCase();
    const fd = new FormData(form);

    const res = await fetch(action, {
      method,
      body: fd,
      headers: { "Accept": "text/html" }
    });

    if (!res.ok) throw new Error("Form submit failed (" + res.status + ")");
  }

  let busy = false;

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    if (busy) return;
    busy = true;

    // ✅ final guard: if USA, block gold even if someone tries to hack the DOM
    setGoldVisibility();
    if (isUnitedStates(countryEl?.value) && (regFor.value || "").toLowerCase().includes("gold")) {
      btn.disabled = false;
      busy = false;
      return show("Gold Card is not available for United States users. Please choose another option.", false);
    }

    const email = (emailEl.value || "").trim().toLowerCase();
    const pwA = (p1.value || "").trim();
    const pwB = (p2.value || "").trim();
    const registering_for = (regFor.value || "").trim();

    const first = String(firstNameEl?.value || "").trim();
    const middle = String(middleNameEl?.value || "").trim();
    const last = String(lastNameEl?.value || "").trim();
    const full_name = [first, middle, last].filter(Boolean).join(" ").trim();

    if (pwA.length < 8) {
      busy = false;
      return show("Password must be at least 8 characters.", false);
    }
    if (pwA !== pwB) {
      busy = false;
      return show("Passwords do not match.", false);
    }
    if (!email || !registering_for) {
      busy = false;
      return show("Please complete required fields.", false);
    }

    const selectedTier = inferTierFromRegisteringFor(registering_for);

    try {
      localStorage.setItem("qfs_registering_for", registering_for);
      localStorage.setItem("qfs_selected_tier", selectedTier);
    } catch {}

    btn.disabled = true;
    show("Creating your portal account…");

    const { error } = await supabase.auth.signUp({
      email,
      password: pwA,
      options: {
        data: {
          registering_for,
          selected_tier: selectedTier,
          first_name: first || null,
          middle_name: middle || null,
          last_name: last || null,
          full_name: full_name || null
        },
        emailRedirectTo: "https://qfsnesaragesara.org/login.html"
      }
    });

    if (error) {
      btn.disabled = false;
      busy = false;
      return show("Signup failed: " + error.message, false);
    }

    show("Account created ✅ Submitting your registration…");

    try {
      await postFormSubmit();
    } catch (err) {
      console.warn(err);
      show("Account created ✅ (Email submission failed, but login is created.)", true);
    }

    window.location.href = "https://qfsnesaragesara.org/success-registration.html";
  });
})();
</script>

</body>
</html>
