<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Gold Portal â€” QFS</title>
<meta name="robots" content="noindex, nofollow">
<link rel="icon" type="image/png" href="https://github.com/qfsnesaragesara/BTC-METAL-CARD-PAYMENT/blob/main/photo%201.jpg?raw=true" />

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  :root{
    --bg:#020617;
    --text:#e5e7eb;
    --muted:#9ca3af;
    --gold:#fbbf24;
    --gold2:#f59e0b;
    --border:rgba(148,163,184,0.45);
    --shadow:rgba(2,6,23,0.9);
    --maxw:1100px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    min-height:100vh;
    padding:24px;
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    color:var(--text);
    background:
      radial-gradient(circle at top, rgba(251,191,36,0.18), transparent 55%),
      radial-gradient(circle at bottom, rgba(245,158,11,0.16), transparent 60%),
      var(--bg);
  }

  .wrap{ max-width:var(--maxw); margin:0 auto; position:relative; z-index:1; }

  .header, .header *{
    position:relative;
    z-index:999999;
    pointer-events:auto !important;
  }

  .header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:14px;
    margin-bottom:18px;
  }
  .brand{ display:flex; align-items:center; gap:12px; }
  .logo{
    width:54px; height:54px;
    border-radius:14px;
    object-fit:cover;
    box-shadow:
      0 14px 44px rgba(2,6,23,0.95),
      0 0 0 1px rgba(148,163,184,0.35);
  }
  .brand h1{ margin:0; font-size:18px; font-weight:900; letter-spacing:-0.02em; }
  .subline{
    font-size:12px;
    color:var(--muted);
    display:flex;
    gap:8px;
    align-items:center;
    flex-wrap:wrap;
    margin-top:2px;
  }
  .hello{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:4px 10px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,0.25);
    background:rgba(255,255,255,0.05);
    color:#fde68a;
    font-weight:850;
    font-size:12px;
  }

  .actions{
    display:flex;
    gap:10px;
    align-items:center;
    flex-wrap:wrap;
    justify-content:flex-end;
  }

  .badge{
    padding:6px 10px;
    border-radius:999px;
    font-size:11px;
    font-weight:900;
    letter-spacing:0.06em;
    text-transform:uppercase;
    border:1px solid rgba(251,191,36,0.30);
    background:rgba(2,6,23,0.40);
    color:#fde68a;
  }
  .badge.active{ border-color: rgba(34,197,94,0.35); color:#bbf7d0; }
  .badge.rejected{ border-color: rgba(244,63,94,0.35); color:#fecdd3; }

  #logoutBtn{
    padding:8px 12px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,0.35);
    background:rgba(255,255,255,0.06);
    color:var(--text);
    font-weight:900;
    font-size:12px;
    cursor:pointer;
  }

  .grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:18px;
  }
  @media (max-width:860px){ .grid{ grid-template-columns:1fr; } }

  .card{
    background:linear-gradient(145deg, rgba(15,23,42,0.96), rgba(15,23,42,0.84));
    border:1px solid var(--border);
    border-radius:28px;
    padding:20px;
    box-shadow: 0 28px 110px var(--shadow);
    backdrop-filter: blur(26px);
    position:relative;
    overflow:hidden;
    z-index:1;
  }
  .card:before{
    content:"";
    position:absolute;
    inset:-120px -120px auto auto;
    width:320px;
    height:320px;
    background: radial-gradient(circle at center, rgba(251,191,36,0.14), transparent 60%);
    pointer-events:none;
  }

  .card h2{ margin:0 0 6px; font-size:16px; font-weight:900; }
  .sub{ font-size:12px; color:var(--muted); }

  .hero{
    font-size:30px;
    font-weight:950;
    margin:10px 0 6px;
    background:linear-gradient(135deg, var(--gold), var(--gold2));
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
  }

  .statusBox{
    margin-top:10px;
    padding:10px 12px;
    border-radius:14px;
    background:rgba(2,6,23,0.45);
    border:1px solid rgba(148,163,184,0.35);
    font-size:12px;
  }

  table{ width:100%; border-collapse:collapse; margin-top:10px; font-size:12px; }
  th, td{ padding:10px 8px; border-bottom:1px solid rgba(148,163,184,0.2); text-align:left; }
  th{ color:var(--muted); font-weight:700; text-transform:uppercase; font-size:11px; }

  #toast{
    position:fixed;
    left:12px;
    bottom:12px;
    z-index:9999999;
    background:rgba(2,6,23,0.75);
    border:1px solid rgba(148,163,184,0.35);
    color:#cbd5e1;
    padding:8px 10px;
    border-radius:12px;
    font-size:12px;
    user-select:none;
    max-width:min(520px, 92vw);
    white-space:pre-wrap;
  }
</style>
</head>

<body>
<div class="wrap">

  <header class="header">
    <div class="brand">
      <img class="logo"
        src="https://github.com/qfsnesaragesara/BTC-METAL-CARD-PAYMENT/blob/main/photo%201.jpg?raw=true"
        alt="QFS NESARA GESARA" />
      <div>
        <h1>Gold Portal</h1>
        <div class="subline">
          <span>QFS NESARA GESARA</span>
          <span class="hello" id="helloName">Hi, Member</span>
        </div>
      </div>
    </div>

    <div class="actions">
      <span id="statusBadge" class="badge">Pending</span>
      <button id="logoutBtn" type="button">Logout</button>
    </div>
  </header>

  <section class="grid">
    <div class="card">
      <h2>Gold Membership</h2>
      <!-- âœ… hide when active -->
      <div class="sub" id="goldHelp">Your gold access becomes active after confirmation.</div>
      <div class="hero">Gold Access</div>
      <div class="statusBox" id="statusBox">ðŸ”’ Locked until activation.</div>
      <div class="sub" style="margin-top:10px;" id="lastChecked">Checking statusâ€¦</div>
    </div>

    <div class="card">
      <h2>Account Details</h2>
      <div class="sub">Gold member profile</div>

      <table>
        <tr><th>Name</th><td id="nameCell">â€”</td></tr>
        <tr><th>Email</th><td id="emailCell">â€”</td></tr>
        <tr><th>Tier</th><td id="tierCell">GOLD</td></tr>
        <tr><th>Status</th><td id="statusCell">Pending</td></tr>
      </table>
    </div>

    <div class="card" style="grid-column:1 / -1;">
      <h2>Gold Features</h2>
      <div class="sub">This area can hold gold-only benefits (coming next).</div>
      <div class="statusBox" style="margin-top:10px;">
        âœ… Priority support â€¢ âœ… Enhanced access â€¢ âœ… Premium portal layout
      </div>
    </div>
  </section>

</div>

<div id="toast">bootâ€¦</div>

<script>
  const SUPABASE_URL = "https://qagktukzxtwbjrdgiben.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFhZ2t0dWt6eHR3YmpyZGdpYmVuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4NDA0NTQsImV4cCI6MjA4MzQxNjQ1NH0.cbhSWHGlmhmIt-NmUVBUtAhPpNPDKk4Bz-Gy1TbPzHk";

  const $ = (id) => document.getElementById(id);
  const toast = $("toast");
  const say = (t) => { if(toast) toast.textContent = String(t || ""); };

  function pickNameFromUser(user){
    const md = user?.user_metadata || {};
    const raw =
      md.full_name ||
      md.name ||
      md.first_name ||
      md.username ||
      md.display_name ||
      "";
    const cleaned = String(raw || "").trim();
    if(cleaned) return cleaned;

    const email = String(user?.email || "").trim();
    if(email && email.includes("@")){
      const left = email.split("@")[0] || "";
      const pretty = left.replace(/[._-]+/g, " ").replace(/\s+/g, " ").trim();
      if(pretty) return pretty.charAt(0).toUpperCase() + pretty.slice(1);
    }
    return "Member";
  }

  function hardToLogin(){
    try{
      localStorage.removeItem("qfsEmail");
      localStorage.removeItem("memberEmail");
      localStorage.removeItem("qfs_registering_for");
    } catch {}
    window.location.replace("login.html");
  }

  function setBadge(status){
    const b = $("statusBadge");
    b.classList.remove("active","rejected");
    if(status === "confirmed"){
      b.textContent = "Active";
      b.classList.add("active");
    } else if(status === "rejected"){
      b.textContent = "Rejected";
      b.classList.add("rejected");
    } else {
      b.textContent = "Pending";
    }
  }

  function setActiveUI(isActive){
    const help = $("goldHelp");
    const box = $("statusBox");
    if(isActive){
      help.style.display = "none";
      box.textContent = "âœ… Gold account active â€” premium access enabled.";
    } else {
      help.style.display = "block";
      box.textContent = "ðŸ”’ Locked until activation.";
    }
  }

  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  async function getDbProfileByEmail(email){
    return await sb
      .from("portal_users")
      .select("email, tier, selected_tier, qty, is_active")
      .eq("email", email)
      .maybeSingle();
  }

  $("logoutBtn").addEventListener("click", async () => {
    say("Signing outâ€¦");
    try{ await sb.auth.signOut(); } catch {}
    hardToLogin();
  });

  (async () => {
    try{
      say("Checking sessionâ€¦");
      const { data } = await sb.auth.getSession();
      const session = data?.session || null;
      if(!session) return hardToLogin();

      const user = session.user || {};
      const email = (user.email || "").trim().toLowerCase();
      if(!email) return hardToLogin();

      const name = pickNameFromUser(user);
      $("helloName").textContent = "Hi, " + name;
      $("nameCell").textContent = name;
      $("emailCell").textContent = email;

      say("Fetching profile by emailâ€¦");
      const { data: profile, error } = await getDbProfileByEmail(email);
      if(error){
        say("Profile SELECT blocked (RLS). portal_users read policy must allow this email.");
        setActiveUI(false);
        setBadge("pending");
        return;
      }
      if(!profile){
        say("No profile row â†’ registration");
        return window.location.replace("registration.html");
      }

      const tier = String(profile.tier || profile.selected_tier || "gold").toLowerCase();
      $("tierCell").textContent = tier.toUpperCase();

      // Safety: if user is not gold anymore, route back to portal.html
      if(tier !== "gold"){
        say("Not gold â†’ redirect portal.html");
        return window.location.replace("portal.html");
      }

      const active = profile.is_active === true;
      $("statusCell").textContent = active ? "Active" : "Pending";
      setBadge(active ? "confirmed" : "pending");
      setActiveUI(active);

      $("lastChecked").textContent = "Last checked: " + new Date().toLocaleString();
      say("Loaded âœ…");

      setInterval(async () => {
        const { data: p2 } = await getDbProfileByEmail(email);
        if(p2){
          const t2 = String(p2.tier || p2.selected_tier || "gold").toLowerCase();
          if(t2 !== "gold") return window.location.replace("portal.html");
          const a2 = p2.is_active === true;
          $("statusCell").textContent = a2 ? "Active" : "Pending";
          setBadge(a2 ? "confirmed" : "pending");
          setActiveUI(a2);
          $("lastChecked").textContent = "Last checked: " + new Date().toLocaleString();
        }
      }, 20000);

    } catch(e){
      say("Boot error: " + (e?.message || e));
    }
  })();
</script>

</body>
</html>
